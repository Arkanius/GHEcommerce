var PMWindow = window.top; if (PMWindow != window) { try { if (!PMWindow.document){ PMWindow = window; }else{ if (!PMWindow._appKey){ window._pmtest = PMWindow.document; PMWindow._appKey = window._appKey; PMWindow.PM = window.PM; delete PMWindow._pmtest; delete window._appKey; delete window.PM;}}} catch (e) { PMWindow = window; }}
!function(e,t,n,i,a){e.PM=e.PM||{},e.PM.Utils=e.PM.Utils||{},e.PM.Utils.core={assertData:function(e,t){if(null===e||e===a)throw"invalid data";if(t&&typeof e!==t)throw"invalid type"}},e.PM=e.PM||{},e.PM.Utils=e.PM.Utils||{},e.PM.Utils.helpFunctions=function(){return{compare:function(e,t){if(e===t)return!0;if(e.length!=t.length)return!1;for(key in e)if(e[key]!==t[key])return!1;return!0},getTextFromElement:function(e){var t;return t=e.innerText?e.innerText:e.textContent,t.replace(/^\s+|\s+$/g,"")},setTextFromElement:function(e,t){e.innerText&&(e.innerText=t),e.textContent=t},stringFormat:function(e,t){return e.replace(/{(\d+)}/g,function(e,n){return"undefined"!=typeof t[n]?t[n]:e})},getKeysFromObject:function(e){var t=[];for(var n in e)t.push(n);return t},dateFormat:function(e){var t=new Date(e);return t.getHours()+":"+(t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes())}}}(),e.PM=e.PM||{},e.PM.Utils=e.PM.Utils||{},e.PM.Utils.base64=function(){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t=function(e){var t,n,i="";for(e=e.replace(/\r\n/g,"\n"),n=0;n<e.length;n++)t=e.charCodeAt(n),128>t?i+=String.fromCharCode(t):t>127&&2048>t?(i+=String.fromCharCode(t>>6|192),i+=String.fromCharCode(63&t|128)):(i+=String.fromCharCode(t>>12|224),i+=String.fromCharCode(t>>6&63|128),i+=String.fromCharCode(63&t|128));return i},n=function(e){for(var t="",n=0,i=0,a=0,s=0;n<e.length;)i=e.charCodeAt(n),128>i?(t+=String.fromCharCode(i),n++):i>191&&224>i?(a=e.charCodeAt(n+1),t+=String.fromCharCode((31&i)<<6|63&a),n+=2):(a=e.charCodeAt(n+1),s=e.charCodeAt(n+2),t+=String.fromCharCode((15&i)<<12|(63&a)<<6|63&s),n+=3);return t},i=function(e){var t,n="";for(t=0;t<e.length;t++)n+=e.charCodeAt(t).toString(16);return n},a=function(e){var t,n="";for(e.length%2>0&&(e="0"+e),t=0;t<e.length;t+=2)n+=String.fromCharCode(parseInt(e.charAt(t)+e.charAt(t+1),16));return n},s=function(n){var i,a,s,o,r,c,l,d="",u=0;for(n=t(n);u<n.length;)i=n.charCodeAt(u++),a=n.charCodeAt(u++),s=n.charCodeAt(u++),o=i>>2,r=(3&i)<<4|a>>4,c=(15&a)<<2|s>>6,l=63&s,isNaN(a)?c=l=64:isNaN(s)&&(l=64),d+=e.charAt(o),d+=e.charAt(r),d+=e.charAt(c),d+=e.charAt(l);return d},o=function(t){var i,a,s,o,r,c,l,d="",u=0;for(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");u<t.length;)o=e.indexOf(t.charAt(u++)),r=e.indexOf(t.charAt(u++)),c=e.indexOf(t.charAt(u++)),l=e.indexOf(t.charAt(u++)),i=o<<2|r>>4,a=(15&r)<<4|c>>2,s=(3&c)<<6|l,d+=String.fromCharCode(i),64!==c&&(d+=String.fromCharCode(a)),64!==l&&(d+=String.fromCharCode(s));return n(d)},r=function(e){return i(o(e))},c=function(e){return s(a(e))};return{encode:s,decode:o,decodeToHex:r,encodeFromHex:c}}(),e.PM=e.PM||{},e.PM.Utils=e.PM.Utils||{},e.PM.Utils.throtle=e.PM.Utils.throtle||function(e,t,n,i){var s,o=this,r=e||500,c=t||1e3,l=n||1500,d={},i=i;this.setThrotle=function(e,t,n){d[e]=d[e]||{callHandlerAt:new Date},d[e].value=t,d[e].changedAt=new Date,d[e].specificHandler=n,s||(s=setInterval(function(){o.throtleValuesChecker()},r))},this.throtleValuesChecker=function(){var e=new Date;for(var t in d){var n=d[t],o=n.changedAt,r=n.callHandlerAt,u=e-o,h=e-r;(u>=c||h>=l)&&(n.specificHandler!==a&&"function"==typeof n.specificHandler?n.specificHandler({id:t,value:n.value}):i!==a&&"function"==typeof i&&i({id:t,value:n.value}),delete d[t])}var p=0;for(var f in d)p++;0===p&&(clearInterval(s),s=null)}},function(){var e=!1,t=/xyz/.test(function(){})?/\b_super\b/:/.*/;this.PMClass=function(){},PMClass.extend=function(n){function i(){!e&&this.init&&this.init.apply(this,arguments)}var a=this.prototype;e=!0;var s=new this;e=!1;for(var o in n)s[o]="function"==typeof n[o]&&"function"==typeof a[o]&&t.test(n[o])?function(e,t){return function(){var n=this._super;this._super=a[e];var i=t.apply(this,arguments);return this._super=n,i}}(o,n[o]):n[o];return i.prototype=s,i.prototype.constructor=i,i.extend=arguments.callee,i}}(),function(e){e.Event=function(e,t,n,i,a){this.name=e,this.category=t,this.action=n,this.label=i,this.value=a}}(e.PM=e.PM||{}),e.PM.xRTML.Templating.bindingHandlers.htmlOrText={update:function(t,n){var i=n(),a=i.match(/(((https?|ftp):\/\/|www\.)[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim);if(i=i.replace(/</g,"&#60;").replace(/>/g,"&#62;"),a)for(var s,o=0,r=0;r<a.length;r++){var c=a[r];s=0===c.toLowerCase().indexOf("www")?'<a href="http://{0}" target="_blank">{0}</a>':'<a href="{0}" target="_blank">{0}</a>',s=e.PM.Utils.helpFunctions.stringFormat(s,[c]),o=i.indexOf(c,o),i=i.substr(0,o)+i.substr(o).replace(c,s),o+=s.length}t.innerHTML=i}},e.PM=e.PM||{},e.PM.EventManager=new function(){var i=this,a={serverChannel:null,clientChannel:null,pingChannel:null,actionMappings:{},pingInterval:null,pingTimer:null},s=function(){a={serverChannel:null,clientChannel:null,actionMappings:{},pingInterval:null,pingTimer:null}},o=function(){a.serverChannel=e.PM.SessionData.account.channels.public_fromClient,a.clientChannel=e.PM.SessionData.account.channels.private_fromClient,a.pingChannel=e.PM.SessionData.account.channels.visitor_ping,a.pingInterval=e.PM.SessionData.pingTime||6e4;var t=[a.serverChannel,a.clientChannel];a.actionMappings={context:[a.clientChannel],fchg:t,visitorSocialInfo:t,VisitorFieldChanged:t,ValueCustomFieldChanged:t,scupdate:t,vlogin:t}},r=function(){o(),i.send("context",{title:t.title,url:t.location.href,date:(new Date).getTime()}),a.pingTimer=setInterval(function(){e.PM.ConnectionManager.send([a.pingChannel],{sid:e.PM.SessionData.account.sessionId,cid:e.PM.SessionData.account.contextId,appkey:e.PM.SessionData.account.appKey})},a.pingInterval),e.PM.ConnectionManager.send([a.pingChannel],{sid:e.PM.SessionData.account.sessionId,cid:e.PM.SessionData.account.contextId,appkey:e.PM.SessionData.account.appKey})};this.send=function(t,i,s){var o=a.actionMappings[t];o||(o=[a.serverChannel]);var r={a:t,d:i};e.PM.ConnectionManager.send(o,r),s||n.IframeManager.sendToParent(r)};var c=function(){null!=a.pingTimer&&clearInterval(a.pingTimer),s()};e.PM.Events.once({pmReady:function(){r(),e.PM.SessionData.account.modules.push("EventManager")},onVisitorDispose:function(){c();var t=e.PM.SessionData.account.modules.indexOf("EventManager");-1!=t&&e.PM.SessionData.account.modules.splice(t,1)}})},function(i,a){i.IframeManager=i.IframeManager||new function(){var s=null,o=null,r=!1,c=[],l=5,d=e.document.hasFocus?e.document.hasFocus():!1;n.xRTML.Common.Browser.isPageFocused=function(){return d};var u=function(t,i){if(i.d&&i.d.focus!==a)if(p.fchg.status[t]=i.d.focus,i.d.focus)d=!0,n.EventManager.send("fchg",{focus:!0});else if(!e.focused){var s=!0;for(var o in p.fchg.status){var r=p.fchg.status[o];if(r){s=!1;break}}s&&(d=!1,n.EventManager.send("fchg",{focus:!1},!0))}},h=function(t){if(t.d&&t.d.focus!==a)if(e.focused)d=!0;else{for(var i in p.fchg.status){var s=p.fchg.status[i];if(s)return d=!0,void n.EventManager.send("fchg",{focus:!0},!0)}d=!1}},p={fchg:{iframe:u,parent:h,status:{}}},f=function(e){try{var t=JSON.parse(e.data);p[t.a]&&p[t.a].iframe&&p[t.a].iframe(e.origin,t)}catch(i){n.xRTML.Console.warn("Unknown message from iframe. ",i)}},v=function(t){for(var n=e.PM.xRTML.Sizzle("iframe",t),i=0;i<n.length;i++)try{var a=n[i].contentWindow;a.document&&(c.push(a),v(a.document))}catch(s){}},g=function(){o=t.createElement("iframe"),o.name="pwmkt",o.height="0px",o.width="0px",o.style.display="none",t.body.appendChild(o),n.xRTML.Event.bind(o.contentWindow,{message:f})};return{init:function(){if(n.SessionData.isEldestPM&&!n.Utils.dom.isCrossOrigin())g(),r=!0;else try{s=e.top.frames.pwmkt,r=!0}catch(t){if(l--,0>l)return;setTimeout(i.IframeManager.init,1e3)}},getChildDomainIframes:function(){return c.length>0?c:(v(),c)},sendToParent:function(e){r&&(s?s.postMessage(n.xRTML.JSON.stringify(e),"*"):p[e.a]&&p[e.a].parent&&p[e.a].parent(e))},dispose:function(){if(r){for(var e in p)p[e].status={};o&&(n.xRTML.Event.unbind(o.contentWindow,{message:f}),t.body.removeChild(o))}}}},e.PM.Events.once({pmReady:function(){i.IframeManager.init(),e.PM.SessionData.account.modules.push("IframeManager")},onVisitorDispose:function(){i.IframeManager.dispose();var t=e.PM.SessionData.account.modules.indexOf("IframeManager");-1!=t&&e.PM.SessionData.account.modules.splice(t,1)}})}(e.PM=e.PM||{}),e.PM.xRTML.ready(function(){e.PM=e.PM||{},e.PM.Facebook=new function(){this._fbroot=null,this._fbAppKey=null,this._fbApiInit=!1;var n=this;this.initialize=function(n){n&&(this._fbAppKey=n,this._fbroot=t.getElementById("fb-root"),this._fbroot||(this._fbroot=t.createElement("div"),this._fbroot.id="fb-root",t.body.appendChild(this._fbroot)),e.fbAsyncInit=e.PM.xRTML.Common.Function.proxy(function(){this._fbApiInit||(this._fbApiInit=!0,FB.init({appId:this._fbAppKey,status:!0,oauth:!1}),FB.getLoginStatus(e.PM.xRTML.Common.Function.proxy(this.fbInitComplete,this)))},this),e.FB?e.fbAsyncInit():this.loadFBsdk())},this.fbInitComplete=function(t){"connected"===t.status?FB.api("/me",e.PM.xRTML.Common.Function.proxy(function(t){t.error?e.PM.xRTML.Console.debug("Facebook: "+t.error):this.sendFacebookInfo(t)},this)):e.PM.xRTML.Console.debug("not_authorized"===t.status?"Facebook: Not authorized":"Facebook: Not logged in")},this.loadFBsdk=function(){var e,n="facebook-jssdk",i=t.getElementsByTagName("script")[0];t.getElementById(n)||(e=t.createElement("script"),e.id=n,e.async=!0,e.src="//connect.facebook.net/en_US/all.js",i.parentNode.insertBefore(e,i))},this.sendFacebookInfo=function(t){if(t){var n=e.PM.Utils.base64.encode(e.PM.xRTML.JSON.stringify(t));e.PM.EventManager.send("visitorSocialInfo",{data:n})}},this.dispose=function(){n._fbroot=null,n._fbAppKey=null,n._fbApiInit=!1}},e.PM.SessionData.isEldestPM&&!n.Utils.dom.isCrossOrigin()&&e.PM.Events.once({pmReady:function(){e.PM.SessionData.socialAppKey&&(n.Facebook.initialize(e.PM.SessionData.socialAppKey),e.PM.SessionData.account.modules.push("Facebook"))},onVisitorDispose:function(){n.Facebook.dispose();var t=e.PM.SessionData.account.modules.indexOf("Facebook");-1!=t&&e.PM.SessionData.account.modules.splice(t,1)}})}),e.PM.SessionData.isEldestPM&&!n.Utils.dom.isCrossOrigin()&&(e.PM=e.PM||{},e.PM.Footprint=function(){return{GetFootprint:function(){var e=this.GetViewportDimensions(),t=this.GtPageSize(),n={};return n.pageSizeWidth=t.width,n.pageSizeHeight=t.height,n.screenWidth=screen.width,n.screenHeight=screen.height,n.viewportWidth=e.width,n.viewportHeight=e.height,n},GtPageSize:function(){var e=new Object;return e.height=Math.max(Math.max(t.body.scrollHeight,t.documentElement.scrollHeight),Math.max(t.body.offsetHeight,t.documentElement.offsetHeight),Math.max(t.body.clientHeight,t.documentElement.clientHeight)),e.width=Math.max(Math.max(t.body.scrollWidth,t.documentElement.scrollWidth),Math.max(t.body.offsetWidth,t.documentElement.offsetWidth),Math.max(t.body.clientWidth,t.documentElement.clientWidth)),e},GetViewportDimensions:function(){var n=new Object;return"undefined"!=typeof e.innerWidth?(n.width=e.innerWidth,n.height=e.innerHeight):"undefined"!=typeof t.documentElement&&"undefined"!=typeof t.documentElement.clientWidth&&0!=t.documentElement.clientWidth?(n.width=t.documentElement.clientWidth,n.height=t.documentElement.clientHeight):(n.width=t.getElementsByTagName("body")[0].clientWidth,n.height=t.getElementsByTagName("body")[0].clientHeight),n}}},e.PM.Events.once({pmReady:function(){var n=(new e.PM.Footprint).GetFootprint();e.PM.EventManager.send("vf",n),e.focused=t.hasFocus?t.hasFocus():!1,e.PM.EventManager.send("fchg",{focus:e.focused})}})),e.PM=e.PM||{},e.PM.Harvest=new function(){var i=this,a=[];this._events={FOCUS:{name:"focus",action:"fchg",key:"Focus",enable:!1},BLUR:{name:"blur",action:"fchg",key:"Blur",enable:!1},CLICK:{name:"click",action:"clk",key:"Click",enable:!1},DBLCLICK:{name:"dblclick",action:"dclk",key:"Double Click",enable:!1},KEYDOWN:{name:"keydown",action:"kdwn",key:"Key Down",enable:!1},KEYUP:{name:"keyup",action:"kup",key:"Key Up",enable:!1},KEYPRESS:{name:"keypress",action:"kprs",key:"Key Press",enable:!1},SCROLL:{name:"scroll",action:"scroll",key:"Scroll",enable:!1},RESIZE:{name:"resize",action:"wrz",key:"Resize",enable:!1},MOUSEMOVE:{name:"mousemove",action:"mmv",key:"Mouse Move",enable:!1},VISIBLEAREA:{name:"visiblearea",action:"va",key:"Visible Area",enable:!1}},this.handlers=new function(){this.OnScrollHandler={execute:function(){if(i._events.SCROLL.enable){var n=e.pageYOffset?e.pageYOffset:t.documentElement.scrollTop?t.documentElement.scrollTop:t.body.scrollTop,a=e.pageXOffset?e.pageXOffset:t.documentElement.scrollLeft?t.documentElement.scrollLeft:t.body.scrollLeft,s={a:"scroll",d:{top:n,left:a}},o=new Array(e.PM.SessionData.account.public_fromClient,e.PM.SessionData.account.private_fromClient);e.PM.ConnectionManager.send(o,s)}},register:function(){var t={};t[i._events.SCROLL.name]=this.execute,e.PM.xRTML.Event.bind(e,t)},unregister:function(){var t={};t[i._events.SCROLL.name]=this.execute,e.PM.xRTML.Event.unbind(e,t)}},this.OnResizeHandler={execute:function(){if(i._events.RESIZE.enable){var t=getViewportDimensions(),n={a:i._events.RESIZE.action,d:{w:t.width,h:t.height}},a=new Array(e.PM.SessionData.account.channels.public_fromClient,e.PM.SessionData.account.channels.private_fromClient);e.PM.ConnectionManager.send(a,n)}},register:function(){var t={};t[i._events.RESIZE.name]=this.execute,e.PM.xRTML.Event.bind(e,t)},unregister:function(){var t={};t[i._events.RESIZE.name]=this.execute,e.PM.xRTML.Event.unbind(e,t)}},this.OnKeyPressHandler={execute:function(t){if(i._events.KEYPRESS.enable){var n={a:"kprs",d:{kcode:"which"in t?t.which:t.keyCode}},a=new Array(e.PM.SessionData.account.public_fromClient,e.PM.SessionData.account.private_fromClient);e.PM.ConnectionManager.send(a,n)}},register:function(){var t={};t[i._events.KEYPRESS.name]=this.execute,e.PM.xRTML.Event.bind(e,t)},unregister:function(){var t={};t[i._events.KEYPRESS.name]=this.execute,e.PM.xRTML.Event.unbind(e,t)}},this.OnKeyDownHandler={execute:function(t){if(i._events.KEYDOWN.enable){var n={a:"kdwn",d:{kcode:"which"in t?t.which:t.keyCode}},a=new Array(e.PM.SessionData.account.public_fromClient,e.PM.SessionData.account.private_fromClient);e.PM.ConnectionManager.send(a,n)}},register:function(){var t={};t[i._events.KEYDOWN.name]=this.execute,e.PM.xRTML.Event.bind(e,t)},unregister:function(){var t={};t[i._events.KEYDOWN.name]=this.execute,e.PM.xRTML.Event.unbind(e,t)}},this.OnKeyUpHandler={execute:function(t){if(i._events.KEYUP.enable){var n={a:"kup",d:{kcode:"which"in t?t.which:t.keyCode}},a=new Array(e.PM.SessionData.account.public_fromClient,e.PM.SessionData.account.private_fromClient);e.PM.ConnectionManager.send(a,n)}},register:function(){var t={};t[i._events.KEYUP.name]=this.execute,e.PM.xRTML.Event.bind(e,t)},unregister:function(){var t={};t[i._events.KEYUP.name]=this.execute,e.PM.xRTML.Event.unbind(e,t)}},this.OnDoubleClickHandler={execute:function(n){if(i._events.DBLCLICK.enable){if(n=n||e.event,null==n.pageX&&null!=n.clientX){var a=t.documentElement,s=t.body;n.pageX=n.clientX+(a.scrollLeft||s&&s.scrollLeft||0),n.pageX-=a.clientLeft||0,n.pageY=n.clientY+(a.scrollTop||s&&s.scrollTop||0),n.pageY-=a.clientTop||0}var o={a:"dclk",d:{x:n.pageX,y:n.pageY}},r=new Array(e.PM.SessionData.account.public_fromClient,e.PM.SessionData.account.private_fromClient);e.PM.ConnectionManager.send(r,o)}},register:function(){var t={};t[i._events.DBLCLICK.name]=this.execute,e.PM.xRTML.Event.bind(e,t)},unregister:function(){var t={};t[i._events.DBLCLICK.name]=this.execute,e.PM.xRTML.Event.unbind(e,t)}},this.OnClickHandler={execute:function(n){if(i._events.CLICK.enable){if(n=n||e.event,null==n.pageX&&null!=n.clientX){var a=t.documentElement,s=t.body;n.pageX=n.clientX+(a.scrollLeft||s&&s.scrollLeft||0),n.pageX-=a.clientLeft||0,n.pageY=n.clientY+(a.scrollTop||s&&s.scrollTop||0),n.pageY-=a.clientTop||0}var o={a:"mclk",d:{x:n.pageX,y:n.pageY}},r=new Array(e.PM.SessionData.account.public_fromClient,e.PM.SessionData.account.private_fromClient);e.PM.ConnectionManager.send(r,o)}},register:function(){var t={};t[i._events.CLICK.name]=this.execute,e.PM.xRTML.Event.bind(e,t)},unregister:function(){var t={};t[i._events.CLICK.name]=this.execute,e.PM.xRTML.Event.unbind(e,t)}},this.OnMouseMoveHandler={execute:function(n){if(i._events.MOUSEMOVE.enable){if(n=n||e.event,null==n.pageX&&null!=n.clientX){var a=t.documentElement,s=t.body;n.pageX=n.clientX+(a.scrollLeft||s&&s.scrollLeft||0),n.pageX-=a.clientLeft||0,n.pageY=n.clientY+(a.scrollTop||s&&s.scrollTop||0),n.pageY-=a.clientTop||0}var o={a:"mmv",d:{x:n.pageX,y:n.pageY}},r=new Array(e.PM.SessionData.account.public_fromClient,e.PM.SessionData.account.private_fromClient);e.PM.ConnectionManager.send(r,o)}},register:function(){var t={};t[i._events.MOUSEMOVE.name]=this.execute,e.PM.xRTML.Event.bind(e,t)},unregister:function(){var t={};t[i._events.MOUSEMOVE.name]=this.execute,e.PM.xRTML.Event.unbind(e,t)}},this.OnFocusChangedHandler={execute:function(){e.focused||(e.focused=!0,i._events.FOCUS.enable&&e.PM.EventManager.send("fchg",{focus:!0}))},register:function(){var t={};t[i._events.FOCUS.name]=this.execute,e.PM.xRTML.Event.bind(e,t);for(var s=0;s<a.length;s++)n.xRTML.Event.bind(a[s],t)},unregister:function(){var t={};t[i._events.FOCUS.name]=this.execute,e.PM.xRTML.Event.unbind(e,t);for(var s=0;s<a.length;s++)n.xRTML.Event.unbind(a[s],t)}},this.OnBlurChangedHandler={execute:function(){e.focused&&(e.focused=!1,i._events.BLUR.enable&&e.PM.EventManager.send("fchg",{focus:!1}))},register:function(){var t={};t[i._events.BLUR.name]=this.execute,e.PM.xRTML.Event.bind(e,t);for(var s=0;s<a.length;s++)n.xRTML.Event.bind(a[s],t)},unregister:function(){var t={};t[i._events.BLUR.name]=this.execute,e.PM.xRTML.Event.unbind(e,t);for(var s=0;s<a.length;s++)n.xRTML.Event.unbind(a[s],t)}},this.OnVisibleAreaChangedHandler={execute:function(){if(i._events.VISIBLEAREA.enable){var n=e.pageYOffset?e.pageYOffset:t.documentElement.scrollTop?t.documentElement.scrollTop:t.body.scrollTop,a=e.pageXOffset?e.pageXOffset:t.documentElement.scrollLeft?t.documentElement.scrollLeft:t.body.scrollLeft,s=e.PM.Footprint.GetViewportDimensions(),o={a:"va",d:{scrLeft:a,scrTop:n,wwidth:s.width,wheight:s.height}},r=new Array(e.PM.SessionData.account.public_fromClient,e.PM.SessionData.account.private_fromClient);e.PM.ConnectionManager.send(r,o)}},register:function(){var t={};t[i._events.SCROLL.name]=this.execute,t[i._events.RESIZE.name]=this.execute,e.PM.xRTML.Event.bind(e,t)},unregister:function(){var t={};t[i._events.SCROLL.name]=this.execute,t[i._events.RESIZE.name]=this.execute,e.PM.xRTML.Event.unbind(e,t)}}},this.initialize=function(e){if(e){for(var t=0;t<e.length;++t){var i=e[t];for(var s in this._events)if(this._events[s].key==i){this._events[s].enable=!0;break}}a=n.IframeManager.getChildDomainIframes(),this.handlers.OnFocusChangedHandler.register(),this.handlers.OnVisibleAreaChangedHandler.register(),this.handlers.OnBlurChangedHandler.register(),this.handlers.OnMouseMoveHandler.register(),this.handlers.OnKeyDownHandler.register(),this.handlers.OnKeyPressHandler.register(),this.handlers.OnKeyUpHandler.register(),this.handlers.OnClickHandler.register(),this.handlers.OnDoubleClickHandler.register(),this.handlers.OnResizeHandler.register(),this.handlers.OnScrollHandler.register()}},this.dispose=function(){this.handlers.OnFocusChangedHandler.unregister(),this.handlers.OnVisibleAreaChangedHandler.unregister(),this.handlers.OnBlurChangedHandler.unregister(),this.handlers.OnMouseMoveHandler.unregister(),this.handlers.OnKeyDownHandler.unregister(),this.handlers.OnKeyPressHandler.unregister(),this.handlers.OnKeyUpHandler.unregister(),this.handlers.OnClickHandler.unregister(),this.handlers.OnDoubleClickHandler.unregister(),this.handlers.OnResizeHandler.unregister(),this.handlers.OnScrollHandler.unregister()}},e.PM.Events.once({pmReady:function(){e.PM.SessionData.PMEvents=["Focus","Blur"],e.PM.SessionData.PMEvents&&(e.PM.Harvest.initialize(e.PM.SessionData.PMEvents),e.PM.SessionData.account.modules.push("Harvest"))},onVisitorDispose:function(){e.PM.Harvest.dispose();var t=e.PM.SessionData.account.modules.indexOf("Harvest");-1!=t&&e.PM.SessionData.account.modules.splice(t,1)}}),function(i){!function(a){var s=!0,o=function(t,n,i){return{question:e.PM.xRTML.Templating.observable(t),rank:e.PM.xRTML.Templating.observable(n),rg:i}};a.BaseInteraction=PMClass.extend({init:function(){},start:function(e){this._liveInteractionConnection=e.liveInteractionConnection,this._interactionId=e.interactionId,this._callOnEndInteraction=e.callOnEndInteraction,this._visitorName=function(){for(var t=n.Interactions.Manager._uiManager.viewModelInstance.visitorInfo(),i="",a=0;a<t.length;a++)"name"==t[a].id&&(i=t[a].value());return""==i?e.visitorName||"Visitor":i}(),this._engineInstance=e.engineInstance,this._operatorInfo=e.operatorInfo,this._externalId=e.externalId},stop:function(){throw"not implemented"},close:function(){throw"not implemented"},connectionLost:function(){throw"not implemented"},connecting:function(){throw"not implemented"},sendMessage:function(t){this._liveInteractionConnection&&(t.sid=e.PM.SessionData.account.sessionId,t.cid=e.PM.SessionData.account.contextId,this._liveInteractionConnection.send({channel:"li:"+this._interactionId+"_"+e.PM.SessionData.account.sessionId,content:"string"==typeof t?t:i.xRTML.JSON.stringify(t)}))},inQueue:function(){throw"not implemented"},terminate:function(){this.feedbackmodel&&this.feedbackmodel.visible(!1)},feedback:function(n){if(s){s=!1;var i=t.createElement("div");t.body.appendChild(i);var a=this,r="pm-feedback-template",c='<div class="pm-rating-container" data-bind="visible: visible"><!-- ko foreach: {data: questions, as: "q" }--><p data-bind="text: q.question"></p><div class="pm-rating-value" data-bind="foreach: {data: [1,2,3,4,5], as:\'r\'}"><input type="radio" data-bind="value: r, checked: q.rank, attr:{name:q.rg}"><i data-bind="text: r"></i></div><!-- /ko --><div class="pm-rating-comments"><p>Observações:</p><textarea name="pm-interaction-rating-comments" id="pm-interaction-rating-comments" cols="30" rows="10" maxlength="255" data-bind="value: comments"></textarea></div><div class="pm-rating-buttons"><button class="pm-rating-close pm-button-no" data-bind="click: closeFeedback ">Fechar</button><button class="pm-rating-send pm-button-yes" data-bind="click: send, enable: sendEnabled">Submeter</button></div></div>';this.feedbackmodel={operationId:n,questions:e.PM.xRTML.Templating.observable([new o("Como o senhor(a) avalia a iniciativa do BB em contatar os clientes via chat?",!1,"rg1"),new o("Como o senhor(a) avalia esse canal de atendimento ao cliente?",!1,"rg2"),new o("O senhor(a) sentiu segurança no atendimento recebido pela internet (chat)?",!1,"rg3"),new o("De uma forma geral como o senhor(a) avalia este atendimento:",!1,"rg4")]),visible:e.PM.xRTML.Templating.observable(!0),rank:e.PM.xRTML.Templating.observable(!1),comments:e.PM.xRTML.Templating.observable(""),send:function(){var e={opid:2,rank:[],iid:a._interactionId,comment:this.comments()};for(var t in a.feedbackmodel.questions()){var n=a.feedbackmodel.questions()[t];e.rank.push({question:n.question(),rank:n.rank()})}a._engineInstance.sendFeedback(e),this.end(!1)},closeFeedback:function(){a._engineInstance.sendFeedback({opid:2,rank:[],iid:a._interactionId,comment:this.comments()}),this.end(!1)},end:function(e){this.visible(!1),e&&a._engineInstance.terminate({opid:2,iid:a._interactionId})}},this.feedbackmodel.sendEnabled=e.PM.xRTML.Templating.observable(function(){var e=!1;for(var t in a.feedbackmodel.questions()){var n=a.feedbackmodel.questions()[t];if(n.rank()){e=!0;break}}return e}),e.PM.xRTML.Templating.inject({content:c,id:r});try{e.PM.xRTML.Templating.applyBindings({node:i,binding:{template:{name:r,data:this.feedbackmodel}}})}catch(l){e.PM.xRTML.Error.raise({code:e.PM.xRTML.Error.Codes.UNEXPECTED,target:this,info:{message:l.message,className:"BaseInteraction",methodName:"Feedback"}})}}else{this.feedbackmodel.operationId=n;for(var d in this.feedbackmodel.questions()){var u=this.feedbackmodel.questions()[d];u.rank(!1)}this.feedbackmodel.comments(""),this.feedbackmodel.visible(!0)}}})}(i.Interactions=i.Interactions||{})}(e.PM=e.PM||{}),function(t){!function(n){n.LiveConnection=function(n,i){var a,s=this,o=t.Events,r=e.PM.xRTML.JSON.stringify({sid:t.SessionData.account.sessionId,cid:t.SessionData.account.contextId,appkey:t.SessionData.account.appKey,iid:i}),c=t.xRTML.ConnectionManager.create({id:i,appKey:t.SessionData.account.appKey,authToken:n,url:t.SessionData.account.ortcServer.url,isCluster:t.SessionData.account.ortcServer.isCluster,heartBeatActive:!0,heartBeatFails:t.SessionData.account.ortcServer.heartBeatFails,heartBeatTime:t.SessionData.account.ortcServer.heartBeatTime,timeout:3e3,connectAttempts:5,metadata:{type:3,sid:t.SessionData.account.sessionId,cid:t.SessionData.account.contextId,iid:i},channels:[{name:"li:"+i}]});c.bind({connect:t.xRTML.Common.Function.proxy(function(){a=setInterval(function(){c.send({channel:"ip",content:r})},t.SessionData.pingTime||6e4)},s),message:t.xRTML.Common.Function.proxy(function(t){var n=e.PM.xRTML.JSON.parse(t.message),i={a:n.a,d:n.d};o.fire({onMessageReceived:{data:i}})},s)}),this.dispose=function(){clearInterval(a),c.dispose()},this.send=function(e){c.send(e)}}}(t.Interactions=t.Interactions||{})}(e.PM=e.PM||{}),function(n){!function(a){var s=function(){var e,t,n,a=null;return{init:function(s,o,r,c){t=parseInt(o()),e=c.owner,n=c,i.Event.bind(s,{keypress:function(i){var s=i?i:event,o=s.keyCode?s.keyCode:s.which?s.which:s.charCode,r=s.srcElement?s.srcElement:s.target;if(13==o&&!s.shiftKey){s.preventDefault?s.preventDefault():s.returnValue=!1;var c=n.messageContent();return n.postMessage({name:e.name(),content:c}),e.isTyping(!1),clearTimeout(a),n.sendTypingMessage(),r.value="",n.messageContent(r.value),!0}return e.isTyping(!0),null!=a&&clearTimeout(a),a=setTimeout(function(){e.isTyping(!1),a=null,n.sendTypingMessage()},t),!0},keydown:function(i){var s=i?i:event,o=s.keyCode?s.keyCode:s.which?s.which:s.charCode;return(8==o||46==o)&&(e.isTyping(n.messageContent().length>0),null!=a&&clearTimeout(a),a=setTimeout(function(){e.isTyping(!1),a=null},t)),!0},keyup:function(i){var s=i?i:event,o=s.keyCode?s.keyCode:s.which?s.which:s.charCode,r=s.srcElement?s.srcElement:s.target;return 13!=o||s.shiftKey||(r.value=""),n.messageContent(r.value),(8==o||46==o)&&(e.isTyping(n.messageContent().length>0),null!=a&&(clearTimeout(a),a=null),a=setTimeout(function(){e.isTyping(!1),a=null},t)),n.sendTypingMessage(),!0}})}}},o=function(){var n=/\.(gif|jpg|jpeg|tiff|png)$/gi,i=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,a=200,s=200,o=function(e,t){var n=t/e;return e>=a&&1>=n?(e=a,t=e*n):t>=s&&(t=s,e=t/n),{width:e,height:t}},r=function(e){var n=t.createElement("a");return n.className="link",n.href=e,n.target="_blank",n.innerText=e,n},c=function(e){var n=t.createElement("a");n.className="link",n.href=e,n.target="_blank";var i=t.createElement("img");return i.className="image",i.src=e,i.alt="Thumbnail - "+e,i.onload=function(){var e=o(i.width,i.height);i.width=e.width,i.height=e.height},n.appendChild(i),n},l=function(e){var n=t.createElement("span");return n.innerText=e,n},d=function(e){var t=e.match(i);if(1==t.length&&t[0].length==e.length){var a=t[0];return[a.match(n)?c(a):r(a)]}for(var s=[],o=0,d=0;d<t.length;d++){var u=t[d],h=e.indexOf(u,o),p=e.indexOf(u,o)+u.length;if(h>o){var f=e.substring(o,h);s.push(l(f))}s.push(r(u)),o=p}if(o<=e.length-1){var f=e.substring(o);s.push(l(f))}return s};return{init:function(t,n,a,s){var o=n(),r=!!o.match(i);if(r)for(var c=d(o),l=0;l<c.length;l++)t.appendChild(c[l]);else e.PM.xRTML.Templating.bindingHandlers.text.update(t,n,a,s)},update:function(){}}},r=function(t){this.id=n.SessionData.account.sessionId,this.name=e.PM.xRTML.Templating.observable(t.name||"Visitor"),this.isTyping=i.Templating.observable(!1)},c=function(t,i,a,s){if(this.sent=i,this.separator=a,this.error=s,this.name=t.name,this.user=t.user,this.srcid=t.srcid,this.content=t.content,this.date=n.xRTML.Templating.observable("string"==typeof t.date?n.Utils.helpFunctions.dateFormat(+new Date(t.date)):"number"==typeof t.date?n.Utils.helpFunctions.dateFormat(t.date):n.Utils.helpFunctions.dateFormat(+new Date)),this.received=n.xRTML.Templating.observable(!1),this.receivedtime=n.xRTML.Templating.observable(""),this.read=n.xRTML.Templating.observable(!1),this.readtime=n.xRTML.Templating.observable(""),this.failed=n.xRTML.Templating.observable(!1),this.retried=n.xRTML.Templating.observable(!1),this.sent){var o=this;this.timeout=setTimeout(function(){o.failed(!0)},e.PM.SessionData.interactions.textChat.messageTimeout)}},l=function(){this.MAX_HISTORY_LENGTH=10,this.MAX_MESSAGE_SIZE=50,this.target=t.createElement("div"),this.target.id="pm-textchat-container",this.target.className="pm-textchat-container",t.body.appendChild(this.target),this.templateContent=function(){return'<div class="pm-textchat"><div class="pm-textchat-header"><h5 class="pm-text-chat-title">Text chat</h5><div class="pm-textchat-close" data-bind="click: closeButtonClick"></div><div class="pm-textchat-minimize" data-bind="click: minimizeButtonClick"></div></div><div class="pm-textchat-operator-photo-container"><div class="pm-textchat-operator-photo"><!-- ko if: operatorPhotoUrl --><img data-bind="attr: {src: operatorPhotoUrl}" alt="Operator photo" /><!-- /ko --></div><span class="pm-textchat-operator-name" data-bind="text: operatorUsername"></span><span class="pm-textchat-id">Protocolo: <span style="color: white;" data-bind="text: externalId" /></span></div><div id="pm-textchat-shoutscontainer" class="pm-textchat-shoutscontainer" ><div class="pm-textchat-messages" data-bind="foreach: pmMessages"><!-- ko ifnot: separator --><div class="pm-textchat-shout" data-bind="css: { operator: !sent, visitor: sent}, visible: !retried()"><p class="pm-textchat-shout-username"><span class="username" data-bind="text: name"></span><span class="time" data-bind="text: date"></span><!-- ko if: sent && $parent.operatorNotifications --><span class="message-status received" data-bind="visible: received">&#10004;</span><span class="message-status read" data-bind="visible: read">&#10004;</span><span class="message-status retry" data-bind="visible: failed, click: function(data, event){ $parent.retryMessage(data); }">Retry</span><!-- /ko --></p><p class="pm-textchat-shout-message" data-bind="chatContent: content"></p></div><!-- /ko --><!-- ko if: separator --><div class="pm-textchat-new-operator"><p data-bind="text: content"></p></div><!-- /ko --></div><!-- operator is typing --><div class="pm-textchat-shout operator"  data-bind="visible: (!connectionLost() && operatorTyping())"><p class="pm-textchat-typing">...</p></div><!-- visitor connecting --><div class="pm-connecting" data-bind="visible: (!connectionLost() && connecting() && !inQueue())"><p>Connecting</p></div><!-- visitor in queue --><div class="pm-connecting" data-bind="visible: inQueue()"><p>In queue. We will be brief</p></div><!-- visitor disconnected --><div class="pm-user-feedback" data-bind="visible: connectionLost"><p>Disconnnected</p></div></div><div class="pm-textchat-shoutform"><textarea class="pm-textchat-shoutform-shoutcontent" placeholder=" " data-bind="disable:(connectionLost() || connecting() || inQueue()), value: messageContent, userTypingBinding: 3000" rows="1" cols="50"></textarea></div><div class="pm-end-textchat" data-bind="visible: endInteractionConfirm"><!-- ko if: !inQueue() --><p>Do you want terminate the text chat?</p><button class="pm-end-textchat-button pm-button-yes" data-bind="click:yesButtonClick">Yes</button><button class="pm-end-textchat-button pm-button-no" data-bind="click:noButtonClick">No</button><!-- /ko --><!-- ko if: inQueue() --><p>Do you want terminate the help request and leave the queue?</p><button class="pm-end-textchat-button pm-button-yes" data-bind="click:stopAndLeaveQueue">Yes</button><button class="pm-end-textchat-button pm-button-no" data-bind="click:noButtonClick">No</button><!-- /ko --></div> </div>'}(),this.template="pmChat-template",this.externalId=i.Templating.observable(""),this.operatorNotifications=e.PM.SessionData.interactions.textChat.operatorNotifications,this.messageContent=i.Templating.observable(""),this.endInteractionConfirm=e.PM.xRTML.Templating.observable(!1),this.connectionLost=e.PM.xRTML.Templating.observable(!1),this.connecting=e.PM.xRTML.Templating.observable(!1),this.inQueue=e.PM.xRTML.Templating.observable(!1),this.operatorTyping=e.PM.xRTML.Templating.observable(!1),this.operatorUsername=e.PM.xRTML.Templating.observable(""),this.operatorPhotoUrl=e.PM.xRTML.Templating.observable(""),this.visitorUsername=e.PM.xRTML.Templating.observable("Visitor"),this.visitorPhotoUrl=e.PM.xRTML.Templating.observable(""),this.owner=new r({name:this.visitorUsername()}),this.pmMessages=e.PM.xRTML.Templating.observable([]),this.minimized=e.PM.xRTML.Templating.observable(!1),this.hasUnreadMessages=n.xRTML.Templating.observable(!1),this.scrollDown=function(){var e=t.getElementById("pm-textchat-shoutscontainer");
e&&(e.scrollTop=e.scrollHeight)},this.yesButtonClick=this.close=function(){this.target.style.display="none",this.endInteractionConfirm(!1),a.Chat.stop(!0)},this.stopAndLeaveQueue=function(){this.target.style.display="none",this.endInteractionConfirm(!1),a.Chat.stop(!0,!0)},this.noButtonClick=function(){this.endInteractionConfirm(!1)},this.closeButtonClick=function(){this.connectionLost()?a.Chat.close():this.endInteractionConfirm(!0)},this.minimizeButtonClick=function(){this.minimized(!this.minimized());var e=t.getElementById("pm-textchat-container");e.className=e.className.indexOf("pm-minimized")>=0?"pm-textchat-container":"pm-textchat-container pm-minimized"},this.sendMessage=function(e){a.Chat.sendMessage(e)},this.postMessage=function(t){if(t.content.length>0){var n=new c({name:this.owner.name(),content:t.content,user:this.owner.id,srcid:e.PM.xRTML.Common.Util.guidGenerator()},!0,!1,!1);o.pmMessages.push(n),o.scrollDown(),this.sendMessage({a:"postMessage",d:{isOperator:!1,srcid:n.srcid,content:n.content,user:n.user,name:n.name}})}};var s=this.owner.isTyping();this.sendTypingMessage=function(){s!=this.owner.isTyping()&&(s=!s,this.sendMessage({a:"typing",d:{typing:s,user:this.owner.id}}))},this.sendUpdateMessage=function(t){var n={a:"updateMessage",d:{srcid:t.srcid,received:!0,user:t.user}};if(e.PM.xRTML.Common.Browser.isPageFocused)n.d.read=!0;else{var i=this;e.PM.xRTML.Common.Browser.once({focus:function(){i.sendMessage({a:"updateMessage",d:{srcid:t.srcid,read:!0,received:!0,user:t.user}})}})}this.sendMessage(n)},this.retryMessage=function(e){e.retried(!0),this.postMessage(e)};var o=this;this.handlers={postMessage:function(e){if(o.connecting(!1),o.target.style.display="block",e.user!==o.owner.id){var t=new c(e,!1,!1,!1);o.pmMessages.push(t),o.sendUpdateMessage(t),o.scrollDown()}else{for(var n=o.pmMessages().length-1;n>=0;n--)if(o.pmMessages()[n].srcid===e.srcid)return;var t=new c(e,!0,!1,!1);clearTimeout(t.timeout),o.pmMessages.push(t),o.scrollDown()}},updateMessage:function(e){if(o.operatorNotifications&&e.user!==o.owner.id)for(var t=!1,i=o.pmMessages().length-1;i>=0&&!t;i--)o.pmMessages()[i].srcid==e.srcid&&(o.pmMessages()[i].received(e.received),o.pmMessages()[i].receivedtime(n.Utils.helpFunctions.dateFormat(e.receivedtime)),e.read&&(o.pmMessages()[i].read(e.read),o.pmMessages()[i].readtime(n.Utils.helpFunctions.dateFormat(e.readtime))),o.pmMessages()[i].timeout&&(clearTimeout(o.pmMessages()[i].timeout),o.pmMessages()[i].timeout=null),t=!0)},typing:function(e){e.user!==o.owner.id&&(o.operatorTyping(!!e.typing),o.scrollDown())}}};a.Chat=new(a.BaseInteraction.extend({init:function(){},inQueue:function(e){this.start(e),this.model.inQueue(!0),this.model.target.style.display="block"},start:function(e,t){if(this._super(e),this._initialized)return this.id=e.interactionId?e.interactionId:n.xRTML.Common.Util.guidGenerator(),this.model.target.style.display="block",this.model.connectionLost(!1),this.model.pmMessages.removeAll(),e.operatorInfo&&(e.operatorInfo.username&&this.model.operatorUsername(e.operatorInfo.username),e.operatorInfo.photoUrl&&this.model.operatorPhotoUrl(e.operatorInfo.photoUrl)),this.model.visitorUsername=this._visitorName,this.model.owner.name(this._visitorName),this.model.externalId(this._externalId?this._externalId:e.externalId),this.model.inQueue(!1),void(t&&t());this._initialized=!0,this._closed=!1;var i=this;this.create(function(){i.model.visitorUsername=i._visitorName,i.model.owner.name(i._visitorName),e.operatorInfo&&(e.operatorInfo.username&&i.model.operatorUsername(e.operatorInfo.username),e.operatorInfo.photoUrl&&i.model.operatorPhotoUrl(e.operatorInfo.photoUrl)),i.model.externalId(i._externalId?"#"+i._externalId:""),t&&t()}),this._engineInstance._messageManager.registerHandlers({postMessage:i.model.handlers.postMessage,updateMessage:i.model.handlers.updateMessage,typing:i.model.handlers.typing})},stop:function(e,t){this.close(),t?this._engineInstance.cancelStartOperation({opid:2,iid:this._interactionId},e):"function"==typeof this._callOnEndInteraction&&this._callOnEndInteraction("textChat",e)},close:function(){this._closed&&this.model&&this.model.target&&(this.model.target.style.display="none"),this._closed=!0},connectionLost:function(e){if(!e&&this.model&&this.model.connectionLost()===!0&&this._closed===!1){var t=new c({user:"Info",srcid:n.xRTML.Common.Util.guidGenerator(),content:"New Chat",date:n.Utils.helpFunctions.dateFormat(+new Date)},!1,!0,!1);this.model.pmMessages.push(t)}this._closed=!1,this.model&&(this.model.connectionLost(e),this.model.scrollDown())},connecting:function(t){if(!t&&this.model.connecting()){var n=this;this.getInteractionHistory(function(i){for(var a=0;a<i.length;a++){var s=new c(i[a],i[a].user===n.model.owner.id,!1,!1);s.read(i[a].read),s.readtime=i[a].readtime,s.received(i[a].received),s.receivedtime(i[a].receivedtime),s.user===n.model.owner.id?(clearTimeout(s.timeout),s.timeout=null):!e.PM.xRTML.Common.Browser.isPageFocused||s.read()&&s.received()||n.sendMessage({a:"updateMessage",d:{user:n.model.owner.id,srcid:s.srcid,received:!0,read:!0}}),n.model.pmMessages.push(s)}n.model.scrollDown(),n.model.connecting(t)})}else this.model.connecting(t)},create:function(t){this.model=new l,e.PM.xRTML.Templating.clearNode(this.model.target),e.PM.xRTML.Templating.bindingHandlers.userTypingBinding=new s,e.PM.xRTML.Templating.bindingHandlers.chatContent=new o,e.PM.xRTML.Templating.inject({content:this.model.templateContent,id:this.model.template});try{e.PM.xRTML.Templating.applyBindings({node:this.model.target,binding:{template:{name:this.model.template,data:this.model}}})}catch(n){e.PM.xRTML.Error.raise({code:e.PM.xRTML.Error.Codes.UNEXPECTED,target:this,info:{message:n.message,className:"PMChat",methodName:"create"}})}t&&t()},getInteractionHistory:function(e){var t=this,n=0,i=function(){n+=1,3>n?(t.sendMessage({a:"getAllMessages",d:{iid:t._interactionId,user:t.model.owner.id}}),a=setTimeout(i,3e3)):e([])},a=setTimeout(i,3e3),s=function(n){n.user===t.model.owner.id&&(t._engineInstance._messageManager.unregisterHandlers({getAllMessages:s}),clearTimeout(a),e(n&&n.messages?n.messages:[]))};t._engineInstance._messageManager.registerHandlers({getAllMessages:s}),this.sendMessage({a:"getAllMessages",d:{iid:t._interactionId,user:t.model.owner.id}})},dispose:function(){if(this.model.target&&this.model.target.parentNode&&(e.PM.xRTML.Templating.clearNode(this.model.target),this.model.target.parentNode.removeChild(this.model.target)),e.PM.xRTML.Sizzle("#"+this.model.template).length>0){var t=e.PM.xRTML.Sizzle("#"+this.model.template)[0];t.parentNode.removeChild(t)}}}))}(n.Interactions=n.Interactions||{})}(e.PM=e.PM||{}),function(n){!function(n,i){n.VideoChat=new(n.BaseInteraction.extend({init:function(){},start:function(t,n){var i=this;return this.videoChatTabTimer,this.videoChatPingsFailed=0,this.videoChatMasterPingSender,this._super(t),this.interactionChannel=e.PM.SessionData.account.channels.private_fromClient+":"+this._interactionId,e.PM.ConnectionManager.connection.subscribe({name:this.interactionChannel}),this._initialized?(this.tagInstance.channelId=this.interactionChannel,this.tagInstance.registerTrigger("videochat_"+t.interactionId),n&&n(),this.connectionLost(!1),this.tagInstance.model.connecting(!0),void this.initPingController()):(this._visitorName=this._visitorName||"me",this.create(function(){i.tagInstance.registerTrigger("videochat_"+t.interactionId),n&&n()}),this._engineInstance._multitabDispacher.registerHandlers({mtab_vchat_close:e.PM.xRTML.Common.Function.proxy(this.close,i)}),this._engineInstance._multitabDispacher.registerHandlers({mtab_vchat_ping:e.PM.xRTML.Common.Function.proxy(function(){this.videoChatPingsFailed=0},i)}),this.connectionLost(!1),this.tagInstance.model.connecting(!0),void(this._initialized=!0))},stop:function(e){this.close(e),"function"==typeof this._callOnEndInteraction&&this._callOnEndInteraction("videoChat",e),this._engineInstance._persistManager.clearVideoChat(),this.tagInstance.unregisterTrigger("videochat_"+this._interactionId),clearInterval(this.videoChatTabTimer),clearInterval(this.videoChatMasterPingSender)},close:function(e){this.tagInstance&&this.tagInstance.model&&this.tagInstance.model.owner.isConnected()&&this.tagInstance.model.disconnect(),e&&(this._target.style.display="none")},connectionLost:function(e){this.tagInstance&&this.tagInstance.model.connectionLost(e)},connecting:function(e){this.tagInstance&&this.tagInstance.model.connecting(e)},initPingController:function(){var t=this;clearInterval(this.videoChatTabTimer),this.videoChatTabTimer=i,clearInterval(this.videoChatMasterPingSender),this.videoChatMasterPingSender=i,this._engineInstance._persistManager.getVideoChatContextId()!==i&&this._engineInstance._persistManager.getVideoChatContextId()!==e.PM.SessionData.account.contextId?(this.videoChatTabTimer=setInterval(e.PM.xRTML.Common.Function.proxy(function(){++this.videoChatPingsFailed>=3&&this.stop()},t),4e3),this._target.style.display="none"):(this.videoChatMasterPingSender=setInterval(e.PM.xRTML.Common.Function.proxy(function(){this._engineInstance._multitabDispacher.syncMultitabs("mtab_vchat_ping",{})},t),4e3),this._target.style.display="block")},create:function(n){var i=this;this._target=t.createElement("div"),this._target.id="pm-videochat_publisher_placeholder",this._target.className="pm-videochat_publisher_placeholder",this.initPingController(),this._engineInstance._persistManager.getVideoChatContextId()!==e.PM.SessionData.account.contextId?this._target.style.display="none":this._target.style.visibility="visible",e.PM.xRTML.TagManager.register({name:"PMVideoChat",base:"Videochat",struct:function(){this.init=function(n,a){this._super(n);try{e.PM.xRTML.Templating.clearNode(this.target[0]),this._videoChatTemplate='<div class="pm-videochat-header"><h4>Video Chat</h4><div class="pm-videochat-close" data-bind="click:leaveVideoChatButton">Close</div><div class="pm-videochat-minimize" data-bind="click: minimizeButtonClick">Minimize</div></div><div class="pm-videochat-streams"><div class="pm-videochat-user pm-videochat-visitor" data-bind="visible: owner.isConnected()"><div class="pm-videochat-stream-container" data-bind="ownerBinding: owner.isConnected()"></div></div><div class="pm-videochat-user pm-videochat-operator" data-bind="css: { \'pm-connecting\': !((!users.length>0) && connectionLost()) }"><div data-bind="foreach: users" ><div class="pm-videochat-stream-container" data-bind="usersBinding: $data"></div></div><div class="pm-user-feedback" data-bind="visible: ((!users.length>0) && connectionLost())"><p class="pm-videochat-ended">The video chat ended.</p></div></div><div class="pm-end-videochat" data-bind="visible: endVideoChatVisible"><p>Do you want terminate the video chat?</p><button class="pm-end-videochat-button pm-button-yes" data-bind="click:yesEndVideoChat">Yes</button><button class="pm-end-videochat-button pm-button-no" data-bind="click:noEndVideoChat">No</button></div>',e.PM.xRTML.Templating.inject({id:"pm-videochat-publisher-template",content:this._videoChatTemplate}),this.model.endVideoChatVisible=e.PM.xRTML.Templating.observable(!1),this.model.yesEndVideoChat=e.PM.xRTML.Common.Function.proxy(function(){this.tagInstance.model.endVideoChatVisible(!1),this.stop(!0),i._engineInstance._multitabDispacher.syncMultitabs("mtab_vchat_close",{})},i),this.model.noEndVideoChat=function(){this.endVideoChatVisible(!1)},this.model.leaveVideoChatButton=function(){this.endVideoChatVisible(!0)},this.model.connectionLost=e.PM.xRTML.Templating.observable(!1),this.model.connecting=e.PM.xRTML.Templating.observable(!1),this.model.username=e.PM.xRTML.Templating.observable("me"),this.model.minimized=e.PM.xRTML.Templating.observable(!1),this.model.minimizeButtonClick=function(){this.minimized(!this.minimized())},this.model.minimized.subscribe(function(e){var n=t.getElementById("pm-videochat_publisher_placeholder");n&&(n.className=e?"pm-videochat_publisher_placeholder pm-minimized":"pm-videochat_publisher_placeholder")}),this.template="pm-videochat-publisher-template",e.PM.xRTML.Templating.applyBindings({node:this.target[0],binding:{template:{name:this.template,data:this.model}}})}catch(s){e.PM.xRTML.Error.raise({code:e.PM.xRTML.Error.Codes.TEMPLATING,target:this,info:{message:s.message,className:"xRTML.Tags."+this.name,methodName:"init"}})}"function"==typeof a&&a(this)}}}),this._templateTag=t.createElement("script"),this._templateTag.type="text/html",this._templateTag.id="videochat-publisher-template";var a="<h3>"+this._visitorName+'</h3><div class="xRTML-VideoChat-Owner" data-bind="ownerBinding: owner.isConnected()"></div><h3>Operator</h3><div class="xRTML-VideoChat-Users" data-bind="foreach: users"><div class="xRTML-VideoChat-User" data-bind="usersBinding: $data"></div></div><div id="topBar-publisher"><div id="links-publisher"><input type="button" value="Yes" id ="connectLink-publisher" data-bind="click: connect,visible: !owner.isConnected()" /><input type="button" value="No" id="refuseSession" data-bind="visible: !owner.isConnected()"/><input type="button" value="Leave" id ="disconnectLink-publisher" data-bind="click: disconnect, visible: owner.isConnected()" /></div></div>';t.body.appendChild(this._target),e.PM.xRTML.Templating.inject({id:"videochat-publisher-template",content:a}),e.PM.xRTML.TagManager.create({name:"PMVideoChat",id:"videochat"+e.PM.SessionData.account.sessionId,maxUsers:2,channelId:this.interactionChannel,connections:[e.PM.ConnectionManager.connection.id],target:"#"+this._target.id,role:"publisher",provider:{name:"tokBox",apiKey:"2644592"},template:"videochat-publisher-template",onError:function(e){console.error(e.message)}},e.PM.xRTML.Common.Function.proxy(function(t){this.tagInstance=t,this.tagInstance.model.username(this._visitorName),t.model.bind({connect:e.PM.xRTML.Common.Function.proxy(function(){this._engineInstance._persistManager.getVideoChatContextId()!==e.PM.SessionData.account.contextId?this._target.style.display="none":this._target.style.visibility="visible",this.tagInstance.model.connectionLost(!1)},i),disconnect:e.PM.xRTML.Common.Function.proxy(function(){var t=e.PM.xRTML.MessageManager.create({trigger:["visitor_disconnected_trigger"],data:{}});e.PM.xRTML.ConnectionManager.sendMessage({connections:[e.PM.ConnectionManager.connection.id],channel:this.interactionChannel,content:t})},i),sessionEnd:e.PM.xRTML.Common.Function.proxy(function(){this.stop(),this.tagInstance.model.connectionLost(!0)},i),error:e.PM.xRTML.Common.Function.proxy(function(t){e.PM.xRTML.Console.log(t)},i)}),n&&n()},i)),e.PM.xRTML.TagManager.create({name:"Execute",id:"xrtml_execute",channelId:this.interactionChannel,connections:[e.PM.ConnectionManager.connection.id],triggers:["invite_videoChat_trigger"],callback:e.PM.xRTML.Common.Function.proxy(function(){var t=e.PM.xRTML.TagManager.getById("videochat"+e.PM.SessionData.account.sessionId);t&&t.model.connect()},i)})},dispose:function(){}}))}(n.Interactions=n.Interactions||{})}(e.PM=e.PM||{}),function(t){!function(t,n){var i=e.PM.Utils.core;t.MultitabDispatcher=function(t){var n=this,i=t||{},a=e.PM.SessionData.account.channels.private_multitab,s=e.PM.SessionData.account.contextId;this.registerHandlers=function(e){for(var t in e)i[t]=e[t]},this.syncMultitabs=function(t,n){var i={a:t,d:n,cid:s};e.PM.ConnectionManager.send([a],i)},this.messageReceived=function(e){var t=e.data;if(t.cid!==s){var n=t.a;if(n&&i[n]){var a=i[n];a(t.d)}}},e.PM.Events.bind({onMessageReceived:e.PM.xRTML.Common.Function.proxy(this.messageReceived,n)})},t.MultitabPingSync=function(t,a){i.assertData(t),i.assertData(a);var s,o,r=this,c=e.PM.SessionData.account.contextId,l=0,d=4,u=5e3,h=function(){if(++l>=d&&o==n){var t=Math.floor(Math.random()*(u/1e3));o=setTimeout(e.PM.xRTML.Common.Function.proxy(function(){p(),a()},r),t)}},p=function(){l=0,t(!0)};this.masterPingReceived=function(e){e.cid<c?t(!1):clearTimeout(o),l=0},this.masterPingSended=function(){l=0},this.startPingsSync=function(i){s===n&&(a(),t(i),s=setInterval(e.PM.xRTML.Common.Function.proxy(h,r),u/2))}}}(t.Interactions=t.Interactions||{})}(e.PM=e.PM||{}),function(t){!function(n){var i=5e3,a=9999999999,s=e.PM.Utils.core,o={disconnected:0,connecting:1,connected:2};n.PingController=function(r,c,l){s.assertData(c);for(var d=this,u={},h=t.Utils.helpFunctions.getKeysFromObject(n.types),p=0;p<h.length;p++)u[h[p]]={currentStatus:o.disconnected,heartbeatTimer:null,failedHeartbeats:0,operationHeartbeat:null};var f=function(t){u[t].heartbeatTimer&&(clearInterval(heartbeatTimer),u[t].heartbeatTimer=null),u[t].heartbeatTimer=setInterval(e.PM.xRTML.Common.Function.proxy(function(){7===++failedHeartbeats&&this.disconnect(t);var e=+new Date;e-u[t].operationHeartbeat>a&&l(t)},d),i)};this.tryConnect=function(e){u[e].currentStatus===o.disconnected&&(u[e].currentStatus=o.connecting,f(e))},this.disconnect=function(e){u[e].currentStatus=o.disconnected,u[e].operationHeartbeat=null,clearInterval(u[e].heartbeatTimer),u[e].heartbeatTimer=null,u[e].failedHeartbeats=0,c(e)},this.heartbeatReceived=function(e){f(e),operationHeartbeats[e]=+new Date,u[e].currentStatus!==o.connected?(u[e].currentStatus=o.connected,r(e)):u[e].failedHeartbeats>0&&(u[e].failedHeartbeats=0)}}}(t.Interactions=t.Interactions||{})}(e.PM=e.PM||{}),function(t){!function(t,n){t.MessageManager=function(t){var i=this;this.messagesTypesHandlers=t||{},this.messageReceived=function(e){var t=e.data;if(t&&t.a){var n=i.messagesTypesHandlers[t.a];"function"==typeof n&&n(t.d)}},this.registerHandlers=function(e){for(var t in e)i.messagesTypesHandlers[t]=e[t]},this.unregisterHandlers=function(e){for(var t in e)i.messagesTypesHandlers[t]==e[t]&&delete i.messagesTypesHandlers[t]},this.unregisterAll=function(e){e?delete i.messagesTypesHandlers[e]:i.messagesTypesHandlers={}},this.sendMessage=function(t,n){e.PM.ConnectionManager.send([n],t)},this.request=function(t,i){if(t&&i){t+="?";var a=!0;for(var s in i)a||(t+="&"),a=!1,null!=i[s]&&i[s]!=n&&(t+=s+"="+i[s])}e.PM.Utils.resources.loadScript(t,null,null,!0)},e.PM.Events.bind({onMessageReceived:i.messageReceived}),this.dispose=function(){i.unregisterAll(),e.PM.Events.unbind({onMessageReceived:i.messageReceived})}}}(t.Interactions=t.Interactions||{})}(e.PM=e.PM||{}),e.PM.xRTML.ready(function(){!function(a){!function(s,o){s.UI=function(){var r=this;this.viewModelInstance;var c=50,l={novalidation:0,email:1,numeric:2};this.interactionsViewModel=function(){var i=this;this.textChatAvailable=e.PM.xRTML.Templating.observable(e.PM.SessionData.textChatAvailable),this.videoChatAvailable=e.PM.xRTML.Templating.observable(e.PM.SessionData.videoChatAvailable),this.callMeNowAvailable=e.PM.xRTML.Templating.observable(e.PM.SessionData.callMeNowAvailable||!0),this.textChatBackoffice=e.PM.xRTML.Templating.observable(e.PM.SessionData.textChatBackoffice),this.videoChatBackoffice=e.PM.xRTML.Templating.observable(e.PM.SessionData.videoChatBackoffice),this.callMeNowBackoffice=e.PM.xRTML.Templating.observable(e.PM.SessionData.callMeNowBackoffice),this.preRequestInfo=e.PM.xRTML.Templating.observable(e.PM.SessionData.preRequestInfo||!0),this.openMenu=e.PM.xRTML.Templating.observable(!1),this.startedInteractions=e.PM.xRTML.Templating.observable(!1),this.interactionRequestType=e.PM.xRTML.Templating.observable(e.PM.Interactions.types.noInteraction),this.isMyRequestType=function(t){return i.interactionRequestType()===e.PM.Interactions.types[t]},this.interactionCustomizableTitle=e.PM.xRTML.Templating.observable(o),this.interactionCustomizableBody=e.PM.xRTML.Templating.observable(o),this.interactionRequestBody=e.PM.xRTML.Templating.observable(e.PM.xRTML.Common.Function.proxy(function(){return this.interactionRequestType()===e.PM.Interactions.types.textChat?this.interactionCustomizableBody()!=o?this.interactionCustomizableBody():"Would you like to begin a text chat?":this.interactionRequestType()===e.PM.Interactions.types.videoChat?"Would you like to begin a video chat?":void 0},i)),this.interactionRequestTitle=e.PM.xRTML.Templating.observable(e.PM.xRTML.Common.Function.proxy(function(){return this.interactionRequestType()===e.PM.Interactions.types.textChat?this.interactionCustomizableTitle()!=o?this.interactionCustomizableTitle():"An operator wants to interact with you.":this.interactionRequestType()===e.PM.Interactions.types.videoChat?"An operator wants to interact with you.":void 0},i)),this.interactionRequestResponse=function(t,n){var a=i.interactionRequestType();t?(r._managerInstance.respondInteractionRequest(!0,a,n),this.interactionRequestType(e.PM.Interactions.types.noInteraction)):(r._managerInstance.respondInteractionRequest(!1,a,n),this.interactionRequestType(e.PM.Interactions.types.noInteraction),r.setMenuState(!1),this.isInInteraction()&&r.setMenuVisibility(!1)),this.interactionCustomizableTitle(o),this.interactionCustomizableBody(o)},this.interactionRequestPending=e.PM.xRTML.Templating.observable(e.PM.xRTML.Common.Function.proxy(function(){return this.interactionRequestType()!==e.PM.Interactions.types.noInteraction},i)),this.isInInteraction=e.PM.xRTML.Templating.observable(e.PM.xRTML.Common.Function.proxy(function(){return this.startedInteractions()===!0||this.interactionRequestPending()===!0},i)),this.selectedInteraction=e.PM.xRTML.Templating.observable(e.PM.Interactions.types.noInteraction),this.currentState=e.PM.xRTML.Templating.observable(e.PM.Interactions.states.disconnected),this.showCancelOnLoading=e.PM.xRTML.Templating.observable(!0),this.isMyState=e.PM.xRTML.Common.Function.proxy(function(t){return this.currentState()===e.PM.Interactions.states[t]},i),this.isMyInteraction=e.PM.xRTML.Common.Function.proxy(function(t){return this.selectedInteraction()===e.PM.Interactions.types[t]},i),this.interactionsMenuOut=e.PM.xRTML.Templating.observable(e.PM.xRTML.Common.Function.proxy(function(){var e=t.getElementById("pm-help-request");e&&(this.openMenu()?this.isMyInteraction("textChat")||this.interactionRequestType()===s.types.textChat?e.className="pm-help-request pm-requesting-textchat":this.isMyInteraction("videoChat")||this.interactionRequestType()===s.types.videoChat?e.className="pm-help-request pm-requesting-videochat":(this.isMyInteraction("callMeNow")||this.interactionRequestType()===s.types.callMeNow)&&(e.className="pm-help-request pm-requesting-callmenow"):e.className="pm-help-request")},i)),this.checkMenuVisibility=e.PM.xRTML.Templating.observable(e.PM.xRTML.Common.Function.proxy(function(){r.setMenuVisibility(this.textChatAvailable()&&this.textChatBackoffice()||this.videoChatAvailable()&&this.videoChatBackoffice()||this.callMeNowAvailable()&&this.callMeNowBackoffice()?this.startedInteractions()===!0?!1:!0:this.interactionRequestType()!==s.types.noInteraction?!0:!1)},i));var c={};c[l.novalidation]=function(){return!0},c[l.email]=function(){return this.value()&&/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(this.value())},c[l.numeric]=function(){return!0},this.visitorInfo=a.xRTML.Templating.observable([]),this.visitorLoggedId=!1,this.markAllAsFilled=function(){for(var e=0;e<this.visitorInfo().length;e++){var t=this.visitorInfo()[e];t.isFilled(this.visitorLoggedId)}};for(var d=0;d<a.SessionData.interactions.helpRequest.length;d++){var u=a.SessionData.interactions.helpRequest[d];if("Autenticado"===u.name)this.visitorLoggedId="True"===u.value;else{var h={id:u.id,name:a.xRTML.Templating.observable(u.name),value:a.xRTML.Templating.observable(u.value||""),type:u.type,isFilled:a.xRTML.Templating.observable(!!u.value),myclass:"pm-label-"+u.name.toLowerCase().replace(/\s/g,"-")};h.validator=a.xRTML.Templating.observable(a.xRTML.Common.Function.proxy(c[u.validation],h)),this.visitorInfo.push(h)}}this.markAllAsFilled(),this.helpDataChanged=function(e){if("Autenticado"==e.name)return this.visitorLoggedId="True"===e.value,void this.markAllAsFilled();for(var t=this.visitorInfo().length-1;t>=0;t--){var n=this.visitorInfo()[t];if(n.id==e.id){n.value(e.value),n.isFilled(!0);break}}},r._managerInstance._messageManager.registerHandlers({helpDataChanged:a.xRTML.Common.Function.proxy(this.helpDataChanged,i)}),this.disabledButton=a.xRTML.Templating.observable(a.xRTML.Common.Function.proxy(function(){for(var e=this.visitorInfo(),t=e.length-1;t>=0;t--)if(!e[t].validator())return!0;return!1}),this),this.operatorInfo={username:e.PM.xRTML.Templating.observable(""),photo:e.PM.xRTML.Templating.observable("")},this.interactionInfoSent=e.PM.xRTML.Templating.observable(!1),this.callMeNowSent=e.PM.xRTML.Templating.observable(!1),this.interactionClick=e.PM.xRTML.Common.Function.proxy(function(t){this.selectedInteraction(e.PM.Interactions.types[t])},i),this.startInteractionClick=function(t){this.startedInteractions()===!1?(s.types[t]===s.types.videoChat,r._managerInstance.tryConnect(e.PM.Interactions.types[t]),s.types[t]===s.types.callMeNow):e.PM.xRTML.Console.debug("Cannot init interaction")},this.cancelConnecting=function(e){r._managerInstance.cancelStartOperation({opid:s.types[e]},!0)},this.contactMeLater=function(t){"Yes"===t?r._managerInstance.sendUserInfoToService({name:this.visitorInfo.name(),email:this.visitorInfo.email()}):"No"===t&&(this.selectedInteraction(e.PM.Interactions.types.noInteraction),r._managerInstance.setDisconnected(i.interactionRequestType()))},this.fireFailedInteractionEvent=function(){var t={sid:e.PM.SessionData.realtimeSessionId,operationType:this.selectedInteraction()};n.Events.fire({interactionRequestExit:t})}},this.initialize=function(n){this._managerInstance=n,this._interactionsMainElement=t.createElement("div"),this._interactionsMainElement.id="pm-help-request",this._interactionsMainElement.className="pm-help-request",this.clickHandlerProxy=e.PM.xRTML.Common.Function.proxy(r.bodyClickHandler,r);var a={},s="ontouchstart"in e||e.DocumentTouch&&t instanceof DocumentTouch?"touchstart":"click";a[s]=r.menuClickHandler,e.PM.xRTML.Event.bind(this._interactionsMainElement,a),t.body.appendChild(this._interactionsMainElement),0==i.Sizzle("#visitor-interaction-template").length&&e.PM.xRTML.Templating.inject({content:this._templateContent,id:"visitor-interaction-template"}),this.viewModelInstance=new this.interactionsViewModel,e.PM.xRTML.Templating.applyBindings({node:this._interactionsMainElement,binding:{template:{name:"visitor-interaction-template",data:this.viewModelInstance}}})},this.dispose=function(){var n={},a="ontouchstart"in e||e.DocumentTouch&&t instanceof DocumentTouch?"touchstart":"click";n[a]=r.menuClickHandler,e.PM.xRTML.Event.unbind(r._interactionsMainElement,n),i.Templating.clearNode(r._interactionsMainElement),this._interactionsMainElement.parentNode.removeChild(this._interactionsMainElement)},this.menuClickDispached=!1,this.menuClickHandler=function(e){r.menuClickDispached=!0;var t=r.checkInsideMenu(e.target||e.srcElement);t&&!r.viewModelInstance.isMyState("connected")&&(r.viewModelInstance.openMenu()||r.setMenuState(!0))},this.bodyClickHandler=function(){return r.menuClickDispached||r.viewModelInstance.interactionRequestPending()?void(r.menuClickDispached=!1):(r.menuClickDispached=!0,void(r.viewModelInstance.openMenu()&&r.viewModelInstance.isMyState("disconnected")&&(r.setMenuState(!1),r.viewModelInstance.selectedInteraction(s.types.noInteraction))))},this.setMenuState=function(n){var i="ontouchstart"in e||e.DocumentTouch&&t instanceof DocumentTouch?"touchstart":"click",a={};a[i]=r.clickHandlerProxy,n?(r.viewModelInstance.openMenu(!0),e.xRTML.Event.bind(t,a)):(r.viewModelInstance.openMenu(!1),e.xRTML.Event.unbind(t,a))},this.setMenuVisibility=function(e){var n=t.getElementById("pm-help-request");n&&(n.style.visibility=e?"visible":"hidden")},this.checkInsideMenu=function(e){return e===t.body||e.parentNode===t.body?!1:e.parentNode===r._interactionsMainElement?!0:r.checkInsideMenu(e.parentNode)},this.forceOpenMenu=function(){r.viewModelInstance.textChatAvailable(!0),r.setTextChatBackofficeFalse=!this.viewModelInstance.textChatBackoffice(),r.viewModelInstance.textChatBackoffice(!0),r.viewModelInstance.interactionClick("textChat"),r.setMenuState(!0),r.viewModelInstance.startInteractionClick("textChat")},this._templateContent="<div class=\"pm-help-btns\"><a class=\"pm-textchat-btn\" data-bind=\"enable: textChatAvailable() ,visible:(textChatBackoffice() && !isInInteraction()),click:function(){ interactionClick('textChat')}, css:{'not-available':!textChatAvailable(), selected:isMyInteraction('textChat') && openMenu(), 'not-selected':!isMyInteraction('textChat') && !isMyState('disconnected') && openMenu()}\">Text Chat</a><a class=\"pm-videochat-btn\" data-bind=\"enable: videoChatAvailable(), visible:(videoChatBackoffice() && !isInInteraction()),click:function(){interactionClick('videoChat')}, css:{'not-available':!videoChatAvailable(), selected:isMyInteraction('videoChat') && openMenu(), 'not-selected':!isMyInteraction('videoChat') && !isMyState('disconnected') && openMenu()}\">Video Chat</a><a class=\"pm-callmenow-btn\" data-bind=\"enable: callMeNowAvailable(),visible:(callMeNowBackoffice() && !isInInteraction()),click:function(){interactionClick('callMeNow')}, css:{'not-available':!callMeNowAvailable(), selected:isMyInteraction('callMeNow') && openMenu(), 'not-selected':!isMyInteraction('callMeNow') && !isMyState('disconnected') && openMenu()}\">Call Me</a></div><!-- textchat starter --><div class=\"pm-interaction-starter pm-textchat-starter\" data-bind=\"visible:(isMyInteraction('textChat') && preRequestInfo() && !isInInteraction() && isMyState('disconnected'))\"><div class=\"pm-starter-screen\"><h5>Text Chat Request</h5>"+'<div class="pre-request-form pm-client-data-for-textchat" id="pm-client-data-for-textchat"><!-- ko foreach: visitorInfo --><label data-bind="text: $data.name, css: $data.myclass, visible: !$data.isFilled()"></label><input type="text" maxlength="'+c+'" value="" name="" data-bind="visible: !$data.isFilled(), css:{invalid: (!$data.validator() && $data.value())},value: $data.value, valueUpdate: \'afterkeydown\'"/><!-- /ko --><div class="pm-buttons"><button class="pm-button-start" data-bind="disable: disabledButton,click:function(){startInteractionClick(\'textChat\');}">Start</button></div></div></div></div><!-- videochat starter --><div class="pm-interaction-starter pm-videochat-starter" data-bind="visible:(isMyInteraction(\'videoChat\') && preRequestInfo() && !isInInteraction() && isMyState(\'disconnected\'))"><div class="pm-starter-screen"><h5>Video Chat Request</h5><div class="pre-request-form pm-client-data-for-videochat" id="pm-client-data-for-videochat"><!-- ko foreach: visitorInfo --><label data-bind="text: $data.name"></label><input type="text" maxlength="'+c+'" value="" name="" data-bind="disable: $data.isFilled, css:{invalid: (!$data.validator() && $data.value())},value: $data.value, valueUpdate: \'afterkeydown\'"/><!-- /ko --><div class="pm-buttons"><button class="pm-button-start" data-bind="disable: disabledButton,click:function(){startInteractionClick(\'videoChat\');}">Start</button></div></div></div></div><!-- confirm interaction init --><div class="pm-interaction-starter pm-textchat-starter" data-bind="visible:!preRequestInfo() && isMyInteraction(\'textChat\') && !isInInteraction() && isMyState(\'disconnected\')"><div class="pm-starter-screen pm-noform"><h5>Text Chat Request</h5><p>Would you like to text chat with an assistant?</p><div class="pm-buttons"><button class="pm-button-yes" data-bind="click:function(){startInteractionClick(\'textChat\');}">Yes</button><button class="pm-button-no" data-bind="click:function(){contactMeLater(\'No\');}">No</button></div></div></div><!-- confirm interaction init --><div class="pm-interaction-starter pm-videochat-starter" data-bind="visible:!preRequestInfo() && isMyInteraction(\'videoChat\')  && !isInInteraction() && isMyState(\'disconnected\')"><div class="pm-starter-screen pm-noform"><h5>Video Chat Request</h5><p>Would you like to video chat with an assistant?</p><div class="pm-buttons"><button class="pm-button-yes" data-bind="click:function(){startInteractionClick(\'videoChat\');}">Yes</button><button class="pm-button-no" data-bind="click:function(){contactMeLater(\'No\');}">No</button></div></div></div><!-- loading interaction --><div class="pm-interaction-loading" data-bind="visible: isMyState(\'connecting\'), css:{ \'pm-textchat-loading\': isMyInteraction(\'textChat\') ,\'pm-videochat-loading\': isMyInteraction(\'videoChat\') }"><div class="pm-loading-screen"><h5>Connecting</h5><div class="pm-buttons"><!-- ko if: isMyInteraction(\'textChat\') --><button class="pm-button-cancel" data-bind="visible: showCancelOnLoading()===true ,click:function(){cancelConnecting(\'textChat\');}">Cancel</button><!-- /ko --><!-- ko if: isMyInteraction(\'videoChat\') --><button class="pm-button-cancel" data-bind="visible: showCancelOnLoading()===true ,click:function(){cancelConnecting(\'videoChat\');}">Cancel</button><!-- /ko --><!-- ko if: isMyInteraction(\'callMeNow\') --><button class="pm-button-cancel" data-bind="visible: showCancelOnLoading()===true ,click:function(){cancelConnecting(\'callMeNow\');}">Cancel</button><!-- /ko --></div></div></div><!-- failed interaction --><div class="pm-interaction-failed" data-bind="visible: isMyState(\'failed\')"><div class="pm-failed-screen pm-noform"><h5 data-bind="visible:!interactionInfoSent()">Connection failed</h5><p>Please try again later.</p><div class="pm-buttons"><button class="pm-button-send" data-bind="click:function(){ fireFailedInteractionEvent(); contactMeLater(\'No\'); }">Ok</button></div><p class="pm-client-data-sent"  data-bind="visible:interactionInfoSent()">Thank you for your submission.</p></div></div><!-- request interaction --><div class="pm-operator-request" data-bind="visible: interactionRequestPending(), css:{ \'pm-textChat-request\':isMyRequestType(\'textChat\'),\'pm-videoChat-request\':isMyRequestType(\'videoChat\') }"><div class="pm-operator-request-screen"><h5 data-bind="text: interactionRequestTitle"></h5><div class="pm-request-photo-container"><div class="pm-request-photo"><!-- ko if: operatorInfo.photo --><img data-bind="attr: {src: operatorInfo.photo}" alt="Operator photo" /><!-- /ko --></div><p class="pm-request-name" data-bind="text: operatorInfo.username"></p></div><p data-bind="text: interactionRequestBody"></p><div class="pm-buttons"><button class="pm-button-yes" data-bind="click:function(){interactionRequestResponse(true, true);}">Yes</button><button class="pm-button-no" data-bind="click:function(){interactionRequestResponse(false, true);}">No</button></div></div></div>'
}}(a.Interactions=a.Interactions||{})}(e.PM=e.PM||{})}),function(t){!function(t){t.Persist=function(t){var n=t,i=null,a=function(){return{pendingInteractions:!1}},s=function(){i||this.initialize(),e.PM.Storage.update(n,i)};this.initialize=function(){var t=e.PM.Storage.get(n);t&&t.value?i=t.value:(i=a(),e.PM.Storage.add(n,i))},this.clear=function(){i=a(),s()},this.hasPendingInteractions=function(){return i.pendingInteractions},this.setPendingInteractions=function(){i.pendingInteractions=!0,s()}}}(t.Interactions=t.Interactions||{})}(e.PM=e.PM||{}),e.PM.xRTML.ready(function(){!function(t){!function(n,i){n.types={noInteraction:0,textChat:2,videoChat:4,callMeNow:8},n.states={disconnected:0,connecting:1,connected:2,failed:3},n.Manager=new function(){var a=this,s=t.Events,o=!1,r=t.xRTML.Common.Function.proxy,c=[],l={requestReceived:0,requestSent:1,chatStarted:2},d=function(e){var t,n=c[e];return n?(t=new Date-n,t/=1e3,c[e]=null,t):i},u=function(e,t){c[e]&&t!==!0||(c[e]=new Date)},h=t.SessionData.segments||[],p={},f={};this.engine={2:{whereIs:t.Interactions.Chat,pollingAndWaiting:!0,name:"textChat",data:{iid:null,token:null,liveConnection:null,inviteResponseTimeout:null,startingOperationsTimeout:null,requestHelpTimeout:null,currentState:n.states.disconnected}},4:{whereIs:t.Interactions.VideoChat,pollingAndWaiting:!0,name:"videoChat",data:{iid:null,token:null,liveConnection:null,inviteResponseTimeout:null,startingOperationsTimeout:null,requestHelpTimeout:null,currentState:n.states.disconnected}},8:{pollingAndWaiting:!1,name:"callMeNow",data:{iid:null,token:null,liveConnection:null,inviteResponseTimeout:null,startingOperationsTimeout:null,requestHelpTimeout:null,currentState:n.states.disconnected}}},this.closingInteraction=null,this.ignoreInvites=!1,this.visitorIsBlocked=e.PM.SessionData.interactions.isBlocked,this.ignoreOperationsAvailability=!1,this.startingOperations={},this.startedOperations={};var v=1e4,g=t.SessionData.interactions.inviteTimeout,m=t.SessionData.interactions.helpRequestTimeout;this.initialize=function(){o!==!0&&(o=!0,this._messageManager=new n.MessageManager({iheartbeat:r(this.heartbeatReceived,a),intopava:r(this.updateOperationsAvailability,a),isblocked:r(this.processIsBlocked,a),vsegments:r(this.updateVisitorSegments,a),handshake:r(this.operatorHandshakeReceived,a),iend:r(this.endOperationReceived,a),iinvcanceled:r(this.cancelInvitation,a),ireqtoken:r(this.interactionRequestResponse,a),ireq:r(this.operationInviteReceived,a),istatus:r(this.onStatusResponse,a),feedback:r(this.terminate,a),irefused:r(this.helpRequestRefused,a),itransfering:r(this.transferReceived,a),ioperatorinfo:r(this.updateOperatorInfo,a)}),this._uiManager=new n.UI,this._uiManager.initialize(a),this._persistManager=new n.Persist("PMInteractions"),this._persistManager.initialize(),this.restoreStartedOperations(),t.ConnectionManager.connection.subscribe({name:e.PM.SessionData.account.channels.interactions}))},this.dispose=function(){for(var n in this.startedOperations)this.engine[n].whereIs.connectionLost(!0),this.disconnected(n,!1),this._uiManager.viewModelInstance.startedInteractions(!1),this._persistManager.clear(),this.checkMenuVisibility(),this._uiManager.setTextChatBackofficeFalse&&(this._uiManager.setTextChatBackofficeFalse=!1,this._uiManager.viewModelInstance.textChatBackoffice(!1)),this.ignoreOperationsAvailability=!1,this.engine[n].whereIs.dispose();this.startedOperations={};for(var n in this.startingOperations)this.engine[n].data.requestHelpTimeout&&(clearTimeout(this.engine[n].data.requestHelpTimeout),this.engine[n].data.requestHelpTimeout=null,this.cancelStartOperation({opid:n},!1)),this.engine[n].data.startingOperationsTimeout&&(clearTimeout(this.engine[n].data.startingOperationsTimeout),this.engine[n].data.startingOperationsTimeout=null,this.operationStartingTimeout(n)),this.engine[n].data.inviteResponseTimeout&&(clearTimeout(this.engine[n].data.inviteResponseTimeout),this.engine[n].data.inviteResponseTimeout=null,this.helpRequestRefused({opid:n})),this.engine[n].whereIs.dispose();this.startingOperations={},o=!1,t.ConnectionManager.connection.isSubscribed(e.PM.SessionData.account.channels.interactions)&&e.PM.ConnectionManager.connection.unsubscribe(e.PM.SessionData.account.channels.interactions),this._messageManager.dispose(),this._uiManager.dispose()},this.startInteractionOrtcConnection=function(e){this.engine[e].data.liveConnection&&(this.engine[e].data.liveConnection.dispose(),this.engine[e].data.liveConnection=null),this.engine[e].data.liveConnection=new n.LiveConnection(this.engine[e].data.token,this.engine[e].data.iid)},this.stopInteractionOrtcConnection=function(){this.closingInteraction&&this.closingInteraction.data.liveConnection&&this.closingInteraction.data.liveConnection.dispose(),this.closingInteraction=null},this.sendFeedback=function(n){this.closingInteraction.data.liveConnection.send({channel:"li:"+n.iid+"_"+e.PM.SessionData.account.sessionId,content:t.xRTML.JSON.stringify({sid:e.PM.SessionData.account.sessionId,cid:e.PM.SessionData.account.contextId,a:"feedback",d:{iid:n.iid,user:e.PM.SessionData.account.sessionId,r:n.rank,c:n.comment}})})},this.requestOperatorInfo=function(){this._messageManager.sendMessage({a:"ireqoperatorinfo",d:{}},t.SessionData.account.channels.public_fromClient)},this.updateOperatorInfo=function(e){e.oinfo&&e.opid&&(this._uiManager.viewModelInstance.operatorInfo.username(e.oinfo.usr),f.username=e.oinfo.usr,this._uiManager.viewModelInstance.operatorInfo.photo(e.oinfo.ph),f.photoUrl=e.oinfo.ph,this.engine[e.opid].data.currentState>0&&(this.engine[e.opid].whereIs.model.operatorUsername(e.oinfo.usr),this.engine[e.opid].whereIs.model.operatorPhotoUrl(e.oinfo.ph)))};var M=!1,b=null;this.restoreStartedOperations=function(){if(this._persistManager.hasPendingInteractions()){var e=3,n=function(){e>0&&(e-=1,a._messageManager.sendMessage({a:"ivstatus",d:{}},t.SessionData.account.channels.public_fromClient),b=setTimeout(n,1e4))};n()}},this.onStatusResponse=function(e){if(!M)if(M=!0,clearTimeout(b),b=null,e.rinfo&&(this._uiManager.viewModelInstance.operatorInfo.username(e.rinfo.usr),f.username=e.rinfo.usr,this._uiManager.viewModelInstance.operatorInfo.photo(e.rinfo.ph),f.photoUrl=e.rinfo.ph),e.ints.length>0)for(var t=0;t<e.ints.length;t++){var n=e.ints[t];this.engine[n.opid].data.currentState>0&&(this.engine[n.opid].whereIs.model.operatorUsername(e.rinfo.usr),this.engine[n.opid].whereIs.model.operatorPhotoUrl(e.rinfo.ph)),0===n.status?(this.engine[n.opid].data.iid=n.iid,this.engine[n.opid].data.token=n.token,this.startInteractionOrtcConnection(n.opid),this.startOperation(n.opid),this.operatorHandshakeReceived(n)):1===n.status?this.interactionRequestResponse(n):2===n.status&&(this.engine[n.opid].data.iid=n.iid,this.engine[n.opid].data.token=n.token,this.operationInviteReceived(n))}else this._persistManager.clear()},this.helpRequestRefused=function(e){this.ignoreInvites=!1,this.engine[e.opid].data.inviteResponseTimeout&&(clearTimeout(this.engine[e.opid].data.inviteResponseTimeout),this.engine[e.opid].data.inviteResponseTimeout=null),this._uiManager.viewModelInstance.interactionRequestType(n.types.noInteraction),this._uiManager.viewModelInstance.operatorInfo.username(""),this._uiManager.viewModelInstance.operatorInfo.photo(""),this.fireInteractionsEvent(e.opid,"Ignored",d(l.requestReceived)),this.setDisconnected(e.opid),0===t.Utils.helpFunctions.getKeysFromObject(this.startedOperations).length&&0===t.Utils.helpFunctions.getKeysFromObject(this.startingOperations).length&&this._persistManager.clear()},this.operationInviteReceived=function(e){this.ignoreInvites||e.opid&&this.engine[e.opid]&&(this.startedOperations[e.opid]||this.startingOperations[e.opid]||(this.startingOperations={},this.ignoreInvites=!0,this.engine[e.opid].data.iid=e.iid,this.engine[e.opid].data.token=e.token,this.startInteractionOrtcConnection(e.opid),e.md&&e.md.i&&(this._uiManager.viewModelInstance.interactionCustomizableTitle(e.md.t),this._uiManager.viewModelInstance.interactionCustomizableBody(e.md.b)),e.rinfo&&(e.rinfo.ph&&(this._uiManager.viewModelInstance.operatorInfo.photo(e.rinfo.ph),f.photoUrl=e.rinfo.ph),e.rinfo.usr&&(this._uiManager.viewModelInstance.operatorInfo.username(e.rinfo.usr),f.username=e.rinfo.usr)),this._uiManager.viewModelInstance.interactionRequestType(e.opid),this._uiManager.setMenuVisibility(!0),this._uiManager.setMenuState(!0),this.fireInteractionsEvent(e.opid,"RequestReceived"),u(l.requestReceived),this.engine[e.opid].data.inviteResponseTimeout=setTimeout(t.xRTML.Common.Function.proxy(function(){this.helpRequestRefused(e)},a),g),e.md&&!e.md.i&&4!==e.opid&&this._uiManager.viewModelInstance.interactionRequestResponse(!0,!0),this._persistManager.setPendingInteractions()))},this.respondInteractionRequest=function(e,i,s){e&&(this._uiManager.viewModelInstance.showCancelOnLoading(!1),this._uiManager.viewModelInstance.currentState(n.states.connecting),this.engine[i].data.currentState===n.states.disconnected&&(this.setConnecting(i),this.engine[i].data.startingOperationsTimeout=setTimeout(t.xRTML.Common.Function.proxy(function(){this.operationStartingTimeout(i)},a),v))),this.ignoreInvites=!1,s===!0&&(this.fireInteractionsEvent(i,e?"Accepted":"Refused",d(l.requestReceived)),this._messageManager.sendMessage({a:"iinvresponse",d:{accept:e,opid:i}},t.SessionData.account.channels.public_fromClient))},this.transferReceived=function(){this.requestOperatorInfo()},this.cancelInvitation=function(e){clearTimeout(this.engine[e.opid].data.inviteResponseTimeout),this.engine[e.opid].data.inviteResponseTimeout=null,this.setDisconnected(e.opid),this.ignoreOperationsAvailability=!1,this.ignoreInvites=!1,this.checkMenuVisibility(),0===t.Utils.helpFunctions.getKeysFromObject(this.startedOperations).length&&0===t.Utils.helpFunctions.getKeysFromObject(this.startingOperations).length&&this._persistManager.clear()},this.tryConnect=function(e){delete this.startingOperations[e],e!=n.types.noInteraction&&this.engine[e].data.currentState===n.states.disconnected&&(this.startingOperations[e]=!0,this.setConnecting(e),this.requestInteraction(e),this.ignoreOperationsAvailability=!0)},this.requestInteraction=function(e){for(var n=this._uiManager.viewModelInstance.visitorInfo().length-1;n>=0;n--){var i=this._uiManager.viewModelInstance.visitorInfo()[n],s={a:"",d:{}};switch(i.type){case 2:s.a="ValueCustomFieldChanged",s.d.customFieldId=i.id;break;case 4:s.a="VisitorFieldChanged",s.d.fieldName=i.id}s.d.value=i.value(),s.d.value&&this._messageManager.sendMessage(s,t.SessionData.account.channels.public_fromClient)}this._persistManager.setPendingInteractions(),this._messageManager.sendMessage({a:"irequesthelp",d:{opid:e}},t.SessionData.account.channels.public_fromClient),this.startingOperations[e]=!0,this.engine[e].data.requestHelpTimeout=setTimeout(t.xRTML.Common.Function.proxy(function(){this.engine[e].data.requestHelpTimeout=null,delete this.startingOperations[e],this.cancelStartOperation({opid:e},!1)},a),m)},this.interactionRequestResponse=function(e){clearTimeout(this.engine[e.opid].data.requestHelpTimeout),this.engine[e.opid].data.requestHelpTimeout=null,this.ignoreOperationsAvailability=!0,this.startingOperations[e.opid]=!0,this.setConnecting(e.opid),this.setInQueue(e.opid),u(l.requestSent),this.fireInteractionsEvent(e.opid,"RequestSent"),e&&e.opid&&e.iid&&(this.engine[e.opid].data.iid=e.iid,this.engine[e.opid].data.token=e.token,this.startInteractionOrtcConnection(e.opid),this.startingOperations[e.opid]=!0,this._uiManager.viewModelInstance.selectedInteraction(e.opid),this.setConnecting(e.opid),this._uiManager.setMenuState(!0)),this.ignoreOperationsAvailability=!0},this.cancelStartOperation=function(e,n){n&&this.engine[e.opid]&&this.engine[e.opid].data.iid&&this._messageManager.sendMessage({a:"icancelhelp",d:{opid:e.opid}},t.SessionData.account.channels.public_fromClient),clearTimeout(this.engine[e.opid].data.requestHelpTimeout),this.engine[e.opid].data.requestHelpTimeout=null,this.setDisconnected(e.opid),this.ignoreOperationsAvailability=!1,this._uiManager.setTextChatBackofficeFalse&&(this._uiManager.setTextChatBackofficeFalse=!1,this._uiManager.viewModelInstance.textChatBackoffice(!1)),0===t.Utils.helpFunctions.getKeysFromObject(this.startedOperations).length&&0===t.Utils.helpFunctions.getKeysFromObject(this.startingOperations).length&&this._persistManager.clear()},this.operatorHandshakeReceived=function(e){return e.extid?(this.engine[e.opid].data.extid=e.extid,clearTimeout(this.engine[e.opid].data.inviteResponseTimeout),this.engine[e.opid].data.inviteResponseTimeout=null,clearTimeout(this.engine[e.opid].data.startingOperationsTimeout),this.engine[e.opid].data.startingOperationsTimeout=null,this.ignoreOperationsAvailability=!1,e.rinfo&&(e.rinfo.usr&&!f.username&&(f.username=e.rinfo.usr),e.rinfo.ph&&!f.photoUrl&&(f.photoUrl=e.rinfo.ph)),u(l.chatStarted),this.startOperation(e.opid),delete this.startingOperations[e.opid],this._uiManager.viewModelInstance.currentState(n.states.connected),this._uiManager.viewModelInstance.showCancelOnLoading(!0),this.connected(e.opid),void this.requestOperatorInfo()):void t.xRTML.Console.error("Received handshake with no externalId. The interaction will be closed.")},this.operationStartingTimeout=function(e){this.engine[e].data.currentState===n.states.connecting&&(this.setDisconnected(e,!1),this.checkMenuVisibility(),this.engine[e].data.startingOperationsTimeout=null,delete this.startingOperations[e],0===t.Utils.helpFunctions.getKeysFromObject(this.startedOperations).length&&0===t.Utils.helpFunctions.getKeysFromObject(this.startingOperations).length&&this._persistManager.clear())},this.endOperationReceived=function(e){8==e.rc&&this.startOperation(e.opid),this.engine[e.opid].whereIs&&this.engine[e.opid].whereIs.connectionLost(!0),0===t.Utils.helpFunctions.getKeysFromObject(this.startedOperations).length&&0===t.Utils.helpFunctions.getKeysFromObject(this.startingOperations).length&&this._persistManager.clear(),this.setEndedOperation(e.opid,e.f),this.ignoreOperationsAvailability=!1,this._uiManager.setTextChatBackofficeFalse&&(this._uiManager.setTextChatBackofficeFalse=!1,this._uiManager.viewModelInstance.textChatBackoffice(!1))},this.startOperation=function(e){var i=!1;this.engine[e].data.currentState===n.states.disconnected&&(this.setConnecting(e),i=!0);var s={interactionId:this.engine[e].data.iid,liveInteractionConnection:this.engine[e].data.liveConnection,callOnEndInteraction:t.xRTML.Common.Function.proxy(this.endOperation,a),visitorName:null,engineInstance:this,operatorInfo:f,externalId:this.engine[e].data.extid};this.engine[e].whereIs.start(s,function(){a.setStartedOperation(e),a._uiManager.setMenuVisibility(!1),a.engine[e].data.inviteResponseTimeout&&(clearTimeout(a.engine[e].data.inviteResponseTimeout),a.engine[e].data.inviteResponseTimeout=null),i&&(u(l.chatStarted,!1),a.setOperationsConnecting(!0))})},this.endOperation=function(e,i){var a="string"==typeof e?n.types[e]:e;i&&(this._messageManager.sendMessage({a:"vopend",d:{opid:a}},t.SessionData.account.channels.public_fromClient),this.startedOperations[a]&&this.fireInteractionsEvent(a,"Closed",d(l.chatStarted)))},this.heartbeatReceived=function(e){(this.engine[e.optype].data.currentState!=n.states.disconnected||this.startedOperations==={})&&this.setOperationsConnecting(!1)},this.operationHeartbeatTimeout=function(e){this.startedOperations[e]&&this.engine[e]&&this.engine[e].whereIs.stop()};var x=function(){for(var e=0,i=0;i<h.length;i++){var a=p[h[i]]||0;e|=a}var s=t.Interactions.Manager._uiManager.viewModelInstance.selectedInteraction();s===n.types.noInteraction||s===n.types.callMeNow||e&s||(this._uiManager.viewModelInstance.selectedInteraction(n.types.noInteraction),this._uiManager.setMenuState(!1)),this._uiManager.viewModelInstance.textChatAvailable(!!(2&e)),this._uiManager.viewModelInstance.videoChatAvailable(!!(4&e))};this.processIsBlocked=function(t){e.PM.SessionData.interactions.isBlocked=!!t.isBlocked,this.visitorIsBlocked=!!t.isBlocked,this.checkMenuVisibility()},this.updateOperationsAvailability=function(e){this.ignoreOperationsAvailability||(p=e.operationAvailability,t.xRTML.Common.Function.proxy(x,a)())},this.updateVisitorSegments=function(e){this.ignoreOperationsAvailability||(h=e.list,t.xRTML.Common.Function.proxy(x,a)())},this.checkMenuVisibility=function(){if(this.visitorIsBlocked)return void this._uiManager.setMenuVisibility(!1);var e=this._uiManager.viewModelInstance.textChatAvailable()&&this._uiManager.viewModelInstance.textChatBackoffice(),t=this._uiManager.viewModelInstance.videoChatAvailable()&&this._uiManager.viewModelInstance.videoChatBackoffice(),n=this._uiManager.viewModelInstance.callMeNowAvailable()&&this._uiManager.viewModelInstance.callMeNowBackoffice();this._uiManager.setMenuVisibility(e||t||n?!0:!1)},this.connected=function(e){this.setConnected(e)},this.setConnected=function(e){this.engine[e].data.currentState=n.states.connected,this._uiManager.viewModelInstance.currentState(n.states.connected),this.setConnectionLost(!1),this.setOperationsConnecting(!1)},this.disconnected=function(e,t){this.setDisconnected(e,t)},this.setDisconnected=function(e,t){this.engine[e].whereIs.close(),this.engine[e].data.currentState=n.states.disconnected,this._uiManager.viewModelInstance.currentState(n.states.disconnected),this._uiManager.viewModelInstance.startedInteractions(!1),this._uiManager.setMenuState(!1),this.setConnectionLost(!0),delete this.startedOperations[e],delete this.startingOperations[e],this._uiManager.viewModelInstance.interactionRequestType(n.types.noInteraction),this._uiManager.viewModelInstance.textChatBackoffice(!this._uiManager.setTextChatBackofficeFalse),this._uiManager.setTextChatBackofficeFalse=!1,this.ignoreOperationsAvailability=!1,this.closingInteraction={instance:this.engine[e].whereIs,data:this.engine[e].data},t?this.closingInteraction.instance.feedback(e):this.stopInteractionOrtcConnection(e),this.engine[e].data={iid:null,token:null,liveConnection:null,inviteResponseTimeout:null,startingOperationsTimeout:null,currentState:n.states.disconnected}},this.terminate=function(e){this.closingInteraction.instance.terminate(),this.stopInteractionOrtcConnection(e.opid)},this.setConnecting=function(e){this.startingOperations[e]=!0,this.engine[e].data.currentState=n.states.connecting,this._uiManager.viewModelInstance.currentState(n.states.connecting)},this.setFailed=function(e){this.engine[e].data.currentState=n.states.failed,this._uiManager.viewModelInstance.currentState(n.states.failed),this.engine[e].data={iid:null,token:null,liveConnection:null,inviteResponseTimeout:null,startingOperationsTimeout:null,currentState:n.states.disconnected},delete this.startingOperations[e]},this.setConnectionLost=function(e){for(var t in this.startedOperations)this.startedOperations[t]&&(e&&this.engine[t].data.currentState===n.states.disconnected&&this.fireInteractionsEvent(t,"LostConnection"),this.engine[t].whereIs.connectionLost(e))},this.setOperationsConnecting=function(e){for(var t in this.startedOperations)this.startedOperations[t]&&this.engine[t].whereIs.connecting(e)},this.setStartedOperation=function(e){this.startedOperations[e]=!0,this._uiManager.viewModelInstance.startedInteractions(!0),this._persistManager.setPendingInteractions()},this.setEndedOperation=function(e,n){delete this.startedOperations[e],this.disconnected(e,n),0===t.Utils.helpFunctions.getKeysFromObject(this.startedOperations).length&&(this._uiManager.viewModelInstance.startedInteractions(!1),this._persistManager.clear(),this.checkMenuVisibility(),this._uiManager.setTextChatBackofficeFalse&&(this._uiManager.setTextChatBackofficeFalse=!1,this._uiManager.viewModelInstance.textChatBackoffice(!1)))},this.setInQueue=function(e){if(this.startingOperations[e]){this._uiManager.setMenuVisibility(!1);var n={interactionId:this.engine[e].data.iid,liveInteractionConnection:this.engine[e].data.liveConnection,callOnEndInteraction:t.xRTML.Common.Function.proxy(this.endOperation,a),visitorName:null,engineInstance:this,operatorInfo:f,externalId:this.engine[e].data.extid};this.engine[e].whereIs.inQueue(n)}},this.fireInteractionsEvent=function(e,n,a){var o=this.engine[e].name,r=o+n,c={};c[r]=new t.Event(r,"Interaction",r,i,a),s.fire(c)}}}(t.Interactions=t.Interactions||{})}(e.PM=e.PM||{}),e.PM.SessionData.isEldestPM&&!n.Utils.dom.isCrossOrigin()&&e.PM.Events.once({pmReady:function(){e.PM.SessionData.account.modules.push("InteractionManager"),e.PM.Interactions.Manager.initialize()},onVisitorDispose:function(){e.PM.Interactions.Manager.dispose();var t=e.PM.SessionData.account.modules.indexOf("InteractionManager");-1!=t&&e.PM.SessionData.account.modules.splice(t,1)}})}),function(e){!function(e){e.base=PMClass.extend({init:function(e,t){this.config=e,this.registerEventHandler=t.registerEventHandler,this.unregisterAllEventHandlers=t.unregisterAllEventHandler,this.registerInteractionEventHandler=t.registerInteractionEventHandler,this.unregisterInteractionEventHandler=t.unregisterInteractionEventHandler,this.unregisterAllInteractionEventHandlers=t.unregisterAllInteractionEventHandlers,this.registerCustomFieldHandler=t.registerCustomFieldHandler,this.unregisterCustomFieldHandler=t.unregisterCustomFieldHandler,this.unregisterAllCustomFieldHandlers=t.unregisterAllCustomFieldHandlers,this.registerVisitorFieldHandler=t.registerVisitorFieldHandler,this.unregisterVisitorFieldHandler=t.unregisterVisitorFieldHandler,this.unregisterAllVisitorFieldHandlers=t.unregisterAllVisitorFieldHandlers},eventReceived:function(){throw"not implemented"},interactionEventReceived:function(){throw"not implemented"},customFieldReceived:function(){throw"not implemented"},dispose:function(){throw"not implemented"}})}(e.Integration=e.Integration||{})}(e.PM=e.PM||{}),function(n,i){!function(n,i){n.analytics=n.base.extend({_valid:!1,init:function(t,n){if(this._super(t,n),this.config=t=e.PM.xRTML.JSON.parse(t),t.dimensions===i||"object"!=typeof t.dimensions)throw"Invalid dimensions object";if(!(t.events!==i&&t.events instanceof Array))throw"Invalid events array";if(!t.id||-1==t.id.indexOf("UA-"))throw"Invalid Universal Analytics Account Id";this.tracker="PM"+t.id.replace(/-/g,""),this._init_tracker(t.id,this.tracker),this.dimensions=t.dimensions;for(var a in t.events)this.registerInteractionEventHandler(t.events[a],e.PM.xRTML.Common.Function.proxy(this.interactionEventReceived,this));for(var s in t.dimensions)isNaN(s)?this.registerVisitorFieldHandler(s,e.PM.xRTML.Common.Function.proxy(this.fieldValueReceived,this)):this.registerCustomFieldHandler(s,e.PM.xRTML.Common.Function.proxy(this.fieldValueReceived,this));this.registerEventHandler("SelectorsFirstIterationCompleted",e.PM.xRTML.Common.Function.proxy(this._customFieldsSend,this)),this._valid=!0},dispose:function(){if(this._valid){for(var e in this.config.events)this.unregisterAllInteractionEventHandlers(this.config.events[e]);for(var t in this.config.dimensions)isNaN(t)?this.unregisterAllVisitorFieldHandlers(t):this.unregisterAllCustomFieldHandlers(t);this.unregisterAllEventHandler("SelectorsFirstIterationCompleted")}},interactionEventReceived:function(e){var t=parseInt(e.value);isNaN(t)&&(t=i),this._send("event",e.category,e.action,e.label,t)},fieldValueReceived:function(e){var t=e.label;if(this.dimensions[t])for(var n in this.dimensions[t])this._set("dimension"+this.dimensions[t][n],e.value)},_customFieldsSend:function(){this._send("event","Custom Dimensions","Submission")},_init_tracker:function(n,i){var a=i;e.GoogleAnalyticsObject&&e[e.GoogleAnalyticsObject]&&"function"==typeof e[e.GoogleAnalyticsObject]?(this.ga=function(){e[e.GoogleAnalyticsObject].apply(this,Array.prototype.slice.call(arguments))},this.ga(e.PM.xRTML.Common.Function.proxy(function(){var t=e[e.GoogleAnalyticsObject].getAll(),i=!1;for(var s in t){var o=t[s],r=o.get("trackingId");r==n&&(this.tracker=a=o.get("name"),i=!0)}i||(this.ga("create",n,{name:a}),this._pageView())},this))):(!function(e,t,n,i,a,s,o){e.GoogleAnalyticsObject=a,e[a]=e[a]||function(){(e[a].q=e[a].q||[]).push(arguments)},e[a].l=1*new Date,s=t.createElement(n),o=t.getElementsByTagName(n)[0],s.async=1,s.src=i,o.parentNode.insertBefore(s,o)}(e,t,"script","//www.google-analytics.com/analytics.js","__pm_ga"),this.ga=function(){e.__pm_ga.apply(null,Array.prototype.slice.call(arguments))},this.ga("create",n,{name:a}),this._pageView())},_pageView:function(){this.ga(this.tracker+".send","pageview")},_set:function(){var e=Array.prototype.slice.call(arguments);e.unshift(".set"),e[0]=this.tracker+".set",this.ga.apply(null,e)},_send:function(){var e=Array.prototype.slice.call(arguments);e.unshift(".send"),e[0]=this.tracker+".send",this.ga.apply(null,e)}})}(n.Integration=n.Integration||{},i)}(e.PM=e.PM||{},a),function(t){!function(i,a){i.manager=new function(){var i,s,o,r,c=e.PM.Events,l={ga:n.Integration.analytics},d=[],u={textChatRequestSent:{active:!0,actionText:"Text Chat Request Sent"},textChatRequestReceived:{active:!0,actionText:"Text Chat Request Received"},textChatAccepted:{active:!0,actionText:"Text Chat Accepted"},textChatRefused:{active:!0,actionText:"Text Chat Refused"},textChatIgnored:{active:!0,actionText:"Text Chat Ignored"},textChatConnected:{active:!0,actionText:"Text Chat Connected"},textChatClosed:{active:!0,actionText:"Text Chat Closed"},textChatOperatorClosed:{active:!0,actionText:"Text Chat Operator Closed"},textChatLostConnection:{active:!0,actionText:"Text Chat Lost Connection"},videoChatRequestSent:{active:!0,actionText:"Video Chat Request Sent"},videoChatRequestReceived:{active:!0,actionText:"Video Chat Request Sent"},videoChatAccepted:{active:!0,actionText:"Video Chat Accepted"},videoChatRefused:{active:!0,actionText:"Video Chat Refused"},videoChatIgnored:{active:!0,actionText:"Video Chat Ignored"},videoChatConnected:{active:!0,actionText:"Video Chat Connected"},videoChatClosed:{active:!0,actionText:"Video Chat Closed"},videoChatOperatorClosed:{active:!0,actionText:"Video Chat Operator Closed"},videoChatLostConnection:{active:!0,actionText:"Video Chat Lost Connection"},callMeNowRequestSent:{active:!1,actionText:"Call Me Now Request Sent"},toastReceived:{active:!0,actionText:"Toast Received"},toastClicked:{active:!0,actionText:"Toast Clicked"},toastIgnored:{active:!0,actionText:"Toast Ignored"},toastClosed:{active:!0,actionText:"Toast Closed"},toasthtmlReceived:{active:!0,actionText:"Toast HTML Received"},toasthtmlIgnored:{active:!0,actionText:"Toast HTML Ignored"},toasthtmlClicked:{active:!0,actionText:"Toast HTML Clicked"},toasthtmlClosed:{active:!0,actionText:"Toast HTML Closed"},htmlReceived:{active:!0,actionText:"HTML Received"},htmlIgnored:{active:!0,actionText:"HTML Ignored"},htmlClosed:{active:!0,actionText:"HTML Closed"},toastimageReceived:{active:!0,actionText:"Toast Image Received"},toastimageIgnored:{active:!0,actionText:"Toast Image Ignored"},toastimageClicked:{active:!0,actionText:"Toast Image Clicked"},toastimageClosed:{active:!0,actionText:"Toast Image Closed"},imageReceived:{active:!0,actionText:"Image Received"},imageClicked:{active:!0,actionText:"Image Clicked"},imageIgnored:{active:!0,actionText:"Image Ignored"},imageClosed:{active:!0,actionText:"Image Closed"},toastvideoReceived:{active:!0,actionText:"Toast Video Received"},toastvideoIgnored:{active:!0,actionText:"Toast Video Ignored"},toastvideoClicked:{active:!0,actionText:"Toast Video Clicked"},toastvideoClosed:{active:!0,actionText:"Toast Video Closed"},videoReceived:{active:!0,actionText:"Video Received"},videoClosed:{active:!0,actionText:"Video Closed"},audioReceived:{active:!0,actionText:"Audio Received"}},h={SelectorsFirstIterationCompleted:{active:!0},SelectorsFirstIterationStarted:{active:!1}};this.initialize=function(p){i=new Object,n.xRTML.Event.extend(i),s=new Object,n.xRTML.Event.extend(s),o=new Object,n.xRTML.Event.extend(o),r=new Object,n.xRTML.Event.extend(r);var f={};for(var v in u)u[v]&&u[v].active&&(f[v]=this.interactionEventFired);c.bind(f);var f={};for(var v in h)h[v]&&h[v].active&&(f[v]=this.eventFired);c.bind(f),c.bind({CustomFieldChanged:this.customFieldFired,PollCustomFieldChanged:this.customFieldFired}),c.bind({VisitorFieldChanged:this.visitorFieldFired});for(var g in p){var m,M=l[g];if(M)for(var b=p[g],x=0;x<b.length;++x){var T=b[x];m=new M(T,{registerEventHandler:this.registerEventNotification,unregisterAllEventHandlers:this.unregisterAllEventNotifications,registerInteractionEventHandler:this.registerInteractionEventNotification,unregisterAllInteractionEventHandlers:this.unregisterAllInteractionEventNotifications,registerCustomFieldHandler:this.registerCustomFieldNotification,unregisterAllCustomFieldHandlers:this.unregisterAllCustomFieldNotifications,registerVisitorFieldHandler:this.registerVisitorFieldNotification,unregisterAllVisitorFieldHandlers:this.unregisterAllVisitorFieldNotifications}),d.push(m)}}var C=e.PM.SessionData.selectors.engines?e.PM.SessionData.selectors.engines[0]:a;C&&C.isFirstIterationCompleted()&&r.fire({SelectorsFirstIterationCompleted:new t.Event("SelectorsFirstIterationCompleted")})},this.eventFired=function(n){try{var i=n.name,a={};a[i]=new t.Event(n.name,n.category,n.action,n.label,n.value),r.fire(a)}catch(s){e.PM.xRTML.Console.log("Error calling eventReceived. "+s)}},this.interactionEventFired=function(n){try{var a=n.name,s=u[n.name]&&u[n.name].actionText?u[n.name].actionText:n.name,o={};o[a]=new t.Event(n.name,n.category,s,n.label,n.value),i.fire(o)}catch(r){e.PM.xRTML.Console.log("Error calling eventReceived. "+r)}},this.customFieldFired=function(n){try{var i=n.label,a={};a[i]=new t.Event(n.name,n.category,n.action,n.label,n.value),s.fire(a)}catch(o){e.PM.xRTML.Console.log("Error calling customFieldReceived. "+o)}},this.visitorFieldFired=function(n){try{var i=n.label,a={};a[i]=new t.Event(n.name,n.category,n.action,n.label,n.value),o.fire(a)}catch(s){e.PM.xRTML.Console.log("Error calling visitorFieldReceived. "+s)}},this.registerEventNotification=function(e,t){if("string"==typeof e&&"function"==typeof t){var i={};i[e]=t,r.bind(i)}else n.xRTML.Console.log("Cannot bind event notification. Invalid event name or notification handler.")},this.unregisterAllEventNotifications=function(e){"string"==typeof e?r.unbindAll(e):n.xRTML.Console.log("Cannot unbind events notification. Invalid event name.")},this.registerInteractionEventNotification=function(e,t){if("string"==typeof e&&"function"==typeof t){var a={};if("all"===e)for(var s in u)u[s]&&u[s].active&&(a[s]=t);else a[e]=t;i.bind(a)}else n.xRTML.Console.log("Cannot bind event notification. Invalid event name or notification handler.")},this.unregisterAllInteractionEventNotifications=function(e){if("string"==typeof e){if("all"===e)for(var t in u)i.unbindAll(t);else i.unbindAll(e)}else n.xRTML.Console.log("Cannot unbind event notification. Invalid event name or notification handler.")},this.registerCustomFieldNotification=function(e,t){if(e&&!isNaN(e)&&"function"==typeof t){var i={};i[e]=t,s.bind(i)}else n.xRTML.Console.log("Cannot bind custom field notification. Invalid custom field id or notification handler.")},this.unregisterAllCustomFieldNotifications=function(e){e&&!isNaN(e)?s.unbindAll(e):n.xRTML.Console.log("Cannot unbind custom field notification. Invalid custom field id.")},this.registerVisitorFieldNotification=function(e,t){if("string"==typeof e&&isNaN(e)&&"function"==typeof t){var i={};i[e]=t,o.bind(i)}else n.xRTML.Console.log("Cannot bind visitor field notification. Invalid visitor field or notification handler.")},this.unregisterAllVisitorFieldNotifications=function(e){"string"==typeof e&&isNaN(e)?o.unbindall(e):n.xRTML.Console.log("Cannot unbind visitor field notification. Invalid visitor field.")},this.dispose=function(){for(var e=0;e<d.length;e++)d[e].dispose();d=[]}}}(t.Integration=t.Integration||{})}(e.PM=e.PM||{}),e.PM.Events.once({pmReady:function(){n.Integration.manager.initialize(n.SessionData.integrations),e.PM.SessionData.account.modules.push("IntegrationManager")},onVisitorDispose:function(){n.Integration.manager.dispose();
var t=e.PM.SessionData.account.modules.indexOf("IntegrationManager");-1!=t&&e.PM.SessionData.account.modules.splice(t,1)}}),e.PM.xRTML.ready(function(){e.PM=e.PM||{},e.PM.LinkedIn=new function(){var t=this;this.initialize=function(t){t&&(e.IN||this.loadLinSDK())},this.loadLinSDK=function(){try{e.PM.Utils.resources.loadScript("http://platform.linkedin.com/in.js",function(){IN.init({api_key:liAppKey,authorize:!0,onLoad:"window.PM.LinkedIn.onLinkedInLoad"})})}catch(t){e.PM.xRTML.Console.log("Linked in api key invalid for the current domain")}},this.onLinkedInLoad=function(){IN.User.isAuthorized()&&IN.Event.on(IN,"auth",e.PM.xRTML.Common.Function.proxy(t.getLinkInInfo,t))},this.getLinkInInfo=function(){IN.API.Profile("me").fields(["id","firstName","lastName","headline","industry","siteStandardProfileRequest"]).result(e.PM.xRTML.Common.Function.proxy(function(e){this.sendLinkedInInfo(e)},t))},this.sendLinkedInInfo=function(t){if(t){var n=e.PM.Utils.base64.encode(e.PM.xRTML.JSON.stringify(t));e.PM.EventManager.send("visitorLinkedInInfo",{data:n})}}},e.PM.SessionData.isEldestPM&&!n.Utils.dom.isCrossOrigin()&&e.PM.Events.once({pmReady:function(){e.PM.SessionData.linkedInAppKey&&n.LinkedIn.initialize(e.PM.SessionData.linkedInAppKey)}})}),function(n){!function(n){n.Utils=function(){var n=[],i=function(e){a(e)||n.push(e)},a=function(e){if(!e)return!0;for(var t=0;t<n.length;t++)if(e===n[t])return!0;return!1};return{getElements:function(t,n,s,o){var r=e.PM.xRTML.Sizzle(t,o);if(0===r.length&&n===!0)for(var c=e.PM.xRTML.Sizzle("iframe",o),l=0;l<c.length;l++){var d=null;try{if(d=c[l].contentWindow,!d||a(d)||!d.document){i(d);continue}if(!d._appKey){var u=d.document;if(u==o)continue;if(r=this.getElements(t,n,s,u),r.length>0)break}}catch(h){i(d)}}return s&&r instanceof Array&&r.length>0?{c:o,r:r}:r},getFactory:function(e){var t=e.prototype.instance;return t||(t=new e,e.prototype.instance=t),t},getViewPort:function(){var n={};return"undefined"!=typeof e.innerWidth?(n.width=e.innerWidth,n.height=e.innerHeight):"undefined"!=typeof t.documentElement&&"undefined"!=typeof t.documentElement.clientWidth&&0!==t.documentElement.clientWidth?(n.width=t.documentElement.clientWidth,n.height=t.documentElement.clientHeight):(n.width=t.getElementsByTagName("body")[0].clientWidth,n.height=t.getElementsByTagName("body")[0].clientHeight),n.y=e.pageYOffset?e.pageYOffset:t.documentElement.scrollTop?t.documentElement.scrollTop:t.body.scrollTop,n.x=e.pageXOffset?e.pageXOffset:t.documentElement.scrollLeft?t.documentElement.scrollLeft:t.body.scrollLeft,n},rectangles:{intercects:function(e,t){return e.x<=t.x+t.width&&t.x<=e.x+e.width&&e.y<=t.y+t.height&&t.y<=e.y+e.height},intersectionArea:function(e,t){var n=Math.max(e.x,t.x),i=Math.min(e.x+e.width,t.x+t.width);if(i>=n){var a=Math.max(e.y,t.y),s=Math.min(e.y+e.height,t.y+t.height);if(s>=a){var o=i-n,r=s-a;return o*r}}return-1}},cookies:{savecustomFieldToCookie:function(t){var n=e.PM.Storage.get("CF"),i=n?n.value:{};i[t.id]=t.value;var a=new Date;a.setDate(a.getDate()+7),n?e.PM.Storage.update("CF",i,a):e.PM.Storage.add("CF",i,a)}}}}()}(n.Selectors=n.Selectors||{})}(e.PM=e.PM||{}),function(e){!function(e){e.Condition=PMClass.extend({init:function(){},_getValidationHandler:function(){return null},_checkCondition:function(){throw"abstract method"},validateCondition:function(e){var t=this._getValidationHandler(e);return t?t(e.value):!0},evaluate:function(e,t){for(var n,i=null,a=!1,s=0;s<e.length;++s)if(n=this._getConditionHandler(e[s]),a=n(t,e[s].value)){i=e[s].result;break}return i}}),e.NumericCondition=e.Condition.extend({init:function(){this.conditionValidationList={7:function(e){return e instanceof Array&&2==e.length},8:function(e){return e instanceof Array&&e.length>0}},this.conditionsList={1:function(e,t){return e==t},2:function(e,t){return e!=t},3:function(e,t){return t>e},4:function(e,t){return t>=e},5:function(e,t){return e>t},6:function(e,t){return e>=t},7:function(e,t){var n=t[0],i=t[1];return e>n&&i>e},8:function(e){for(var t,n=0;n<condArray.length;++n)if(t=parseFloat(condArray[n]),e==t)return!0;return!1}}},_getValidationHandler:function(e){return this.conditionValidationList[e.operator]},_getConditionHandler:function(e){return this.conditionsList[e.operator]}}),e.TextCondition=e.Condition.extend({init:function(){this.conditionsList={101:function(e,t){return e==t},102:function(e,t){return e!=t},103:function(e,t){return e.toLowerCase()==t.toLowerCase()},104:function(e,t){return-1!=e.indexOf(t)},105:function(e,t){return-1==e.indexOf(t)},106:function(e,t){return 0==e.indexOf(t)},107:function(e,t){return e.match(t+"$")==t},108:function(e){return 0==e.length},109:function(e){return e.length>0}}},_getConditionHandler:function(e){var t=this;return function(n,i){var a=n.toLowerCase(),s=i.toLowerCase();return t.conditionsList[e.operator](a,s)}}}),e.BooleanCondition=e.Condition.extend({init:function(){this.conditionsList={201:function(e){return e},202:function(e){return!e}}},_getConditionHandler:function(e){return this.conditionsList[e.operator]}})}(e.Selectors=e.Selectors||{})}(e.PM=e.PM||{}),function(n){!function(n,a){n.Expression=PMClass.extend({init:function(t,n,i){e.PM.xRTML.Event.extend(this),this.expressionData=t,this.expressionData.conditions&&t.conditions.length>0&&(this.conditionHandler=n(),this.conditionsAnalyser=function(e){var n=this.conditionHandler.evaluate(t.conditions,e);return"[object Array]"===Object.prototype.toString.call(t.conditions)&&t.conditions.length>0&&this.fire({conditionUpdate:{value:n,expressionData:t}}),n}),t.parser&&i&&(this.parserHandler=i(),this.parserAnalyser=function(e){var n=this.parserHandler.evaluate(t.parser,e);return"[object Array]"===Object.prototype.toString.call(t.parser)&&t.parser.length>0&&this.fire({cleanupUpdate:{value:n,expressionData:t}}),n})},getData:function(){return this.expressionData},_getElement:function(e,t){var i=n.Utils.getElements(this.expressionData.expression,e);return!t&&i.length>0&&(i=i.slice(0,1)),i},_internalGetValue:function(){throw"abstract method"},getValue:function(e,t){for(var n=this._getElement(e,t),i=0;i<n.length;++i){var a=this._internalGetValue(n[i]);n[i]=this.expressionData.conditions&&this.expressionData.conditions.length>0?this.conditionsAnalyser(a):a}return result=t?n:n&&n.length>0?n[0]:null}}),n.VisibilityExpression=n.Expression.extend({init:function(t,i){this._super(t,i);var a=e.PM.xRTML.Common.Function.proxy(function(){this.viewport=n.Utils.getViewPort()},this);e.PM.xRTML.Event.bind(e,{scroll:a}),e.PM.xRTML.Event.bind(e,{resize:a}),a()},_checkType:function(){if(isNaN(result))throw"Invalid numeric field in "+expressionData.expression+" expression or some condition"},_getElementPosition:function(e){for(var n=0,i=0;e&&!isNaN(e.offsetLeft)&&!isNaN(e.offsetTop);)n+=e.offsetLeft,i+=e.offsetTop,e!=t&&(n-=e.scrollLeft,i-=e.scrollTop),e=e.offsetParent;return{top:i,left:n}},_internalGetValue:function(e){var t=this._getElementPosition(e),i={x:t.left,y:t.top,height:e.clientHeight,width:e.clientWidth},a=i.height*i.width*(this.expressionData.percentageVisible||1),s=!1;if(i.x+=this.viewport.x,i.y+=this.viewport.y,n.Utils.rectangles.intercects(this.viewport,i)){var o=n.Utils.rectangles.intersectionArea(this.viewport,i);s=o>=a}return this.fire({readUpdate:{value:s,expressionData:this.expressionData}}),s}}),n.ValueExpression=n.Expression.extend({init:function(e,t,n){if(this._super(e,t,n),this.expressionData.conditions&&this.expressionData.conditions.length>0)for(var i,a=0;a<this.expressionData.conditions.length;++a){if(i=this.expressionData.conditions[a].value,i instanceof Array)for(var s=0;s<i.length;++s)this._checkType(i[s]);else this._checkType(i);this.conditionHandler.validateCondition(this.expressionData.conditions[a])}},_internalGetValue:function(t){var n=this.expressionData.attribute,i="innerText"==n?e.PM.Utils.helpFunctions.getTextFromElement(t):t["class"==n?"className":n];return this.fire({readUpdate:{value:i,expressionData:this.expressionData}}),this.expressionData.parser&&(i=this.parserAnalyser(i)),i=this._convertType(i)},_checkType:function(){throw"abstract class, must override method checkType"},_convertType:function(){throw"abstract class, must override method convertToValue"}}),n.TextExpression=n.ValueExpression.extend({init:function(e,t,n){this._super(e,t,n)},_checkType:function(e){if(e==a||"string"!=typeof e)throw"Invalid text field in "+expressionData.expression+" expression or some condition"},_convertType:function(e){return this._checkType(e),e}}),n.NumericExpression=n.ValueExpression.extend({init:function(e,t,n){this._super(e,t,n)},_checkType:function(e){if(isNaN(parseFloat(e)))throw"Invalid numeric field in "+expressionData.expression+" expression or some condition"},_convertType:function(e){var t=parseFloat(e);try{this._checkType(e)}catch(n){return null}return t}}),n.BooleanExpression=n.ValueExpression.extend({init:function(e,t,n){this._super(e,t,n)},_checkType:function(e){if(e==a||"boolean"!=typeof e&&"True"!==e)throw"Invalid text field in "+expressionData.expression+" expression or some condition"},_convertType:function(e){return this._checkType(e),e}}),n.DateValueExpression=n.Expression.extend({init:function(e,t,n){this._super(e,t,n)},_internalGetValue:function(t){var n="";if("innerText"==this.getData().attribute)n=e.PM.Utils.helpFunctions.getTextFromElement(t);else if(t.hasChildNodes())for(var a=e.PM.xRTML.Sizzle(this.getData().expression+">*"),s=0;s<a.length;s++)a[s].options&&a[s].selectedIndex&&a[s].options.length>0?n+=a[s].options[a[s].selectedIndex].value.trim()+" ":a[s].value&&""!=a[s].value&&(n+=a[s].value.trim()+" ");else"SELECT"==t.tagName?n+=t.options[t.selectedIndex].value.trim()+" ":t.value&&""!=t.value&&(n+=t.value.trim()+" ");return n=this._convertType(e.PM.xRTML.Common.String.trim(n)),this.fire({readUpdate:{value:i.Moment(n).format("DD-MM-YYYY"),expressionData:this.expressionData}}),n},_checkType:function(e){if(!e.isValid())throw"Invalid date selector."},_convertType:function(t){var n=this.getData().dateMask,i=t.replace(new RegExp(" ","g"),"-"),a=e.PM.xRTML.Moment(i,n);return this._checkType(a),1e3*a.unix()}}),n.EventExpression=n.Expression.extend({init:function(t,n){var a=this;this._super(t,n);var s=this.eventTypes[t.attribute.toLowerCase()]||[],o=i.Sizzle(t.expression).length>0?i.Sizzle(t.expression)[0]:null,r=function(e){a.eventHandlers[e.type]&&(a.eventHandlers[e.type].call(a,e),a.fire({eventValueUpdate:{value:a.currentValue}}))};if(o)for(var c=0;c<s.length;c++)!function(t,n){var i={};i[n]=r,e.PM.xRTML.Event.bind(t,i)}(o,s[c])},eventTypes:{click:["click"],mouseover:["mouseover","mouseout"]},currentValue:!1,_internalGetValue:function(){return this.currentValue},eventHandlers:{click:function(){this.currentValue=!0},mouseover:function(){this.currentValue=!0},mouseout:function(){this.currentValue=!1}},_checkType:function(e){if("boolean"!=typeof e)throw"Invalid boolean field in "+expressionData.expression+" expression or some condition"},_convertType:function(e){return this._checkType(e),e}}),n.ExpressionFactory=function(){var e=null,t={},i={1:function(){return new n.NumericCondition},2:function(){return new n.TextCondition},3:function(){return new n.BooleanCondition}},a=function(e){var n=t[e];return n||(n=t[e]=i[e]()),n},s=function(){return e||(e=new n.Parser),e},o={1:function(e){return new n.NumericExpression(e,function(){return a(1)},function(){return s()})},2:function(e){return new n.TextExpression(e,function(){return a(2)},function(){return s()})},3:function(e){return new n.VisibilityExpression(e,function(){return a(3)})},4:function(e){return new n.PollNumericExpression(e,function(){return a(1)},function(){return s()})},5:function(e){return new n.PollTextExpression(e,function(){return a(2)},function(){return s()})},6:function(e){return new n.BooleanExpression(e,function(){return a(3)},function(){return s()})},7:function(e){return new n.DateValueExpression(e,function(){return a(2)},function(){return s()})},8:function(e){return new n.EventExpression(e,function(){return a(3)},function(){return s()})}};this.createInstance=function(e){var t=o[e.attributeType];if(!t)throw"unknown expression atribute type: "+e.attributeType;return t(e)}}}(n.Selectors=n.Selectors||{})}(e.PM=e.PM||{}),function(e){!function(e){e.Parser=PMClass.extend({init:function(){this.parserOperationsList={400:function(e,t){try{var n=new RegExp(t.r,"g");return e.replace(n,"")}catch(i){throw"Invalid regular expression "}},401:function(e,t){var n=t.n;return e.substring(n)},402:function(e,t){var n=t.n;return e.substring(0,e.length-n)},403:function(e,t){var n=e;return t.all?n=n.split(t.s).join(t.by):n.replace(t.s,t.by)}},this.validateConfig={400:function(e){return e&&"string"==typeof e.r},401:function(e){return e&&"number"==typeof e.n},402:function(e){return e&&"number"==typeof e.n},403:function(e){return"string"!=typeof e.s||"string"!=typeof e.by?!1:!0}}},_getParserHandler:function(e){return this.parserOperationsList[e]},_getParserConfigValidator:function(e){return this.validateConfig[e]},evaluate:function(e,t){for(var n,i,a=t,s=0;s<e.length;++s)n=this._getParserHandler(e[s].parserId),i=this._getParserConfigValidator(e[s].parserId),n&&i(e[s])&&(a=n(a,e[s]));return a}})}(e.Selectors=e.Selectors||{})}(e.PM=e.PM||{}),function(t){!function(t,n){t.PollExpression=t.Expression.extend({init:function(e,t,n){this._super(e,t,n)},getValue:function(e){var t,n=this._getElement(e),i=this._internalGetValue(n);return t=i&&this.expressionData.conditions&&this.expressionData.conditions.length>0?this.conditionsAnalyser(i):i},_getElement:function(e){var n=t.Utils.getElements(this.expressionData.expression,e,!0),i=null;if(n.r){var a=n.r;i=a.length>0?a[0]:null}return this.context=n.c,this._internalGetElement(i)},_internalGetElement:function(t){if(!t)return null;if("INPUT"===t.tagName&&"radio"===t.type)return t;if("LABEL"===t.tagName){var n=t.attributes["for"].value,i=e.PM.xRTML.Sizzle("#"+n,this.context)[0];return this._internalGetElement(i)}var a=t.getElementsByTagName("input");if(a.length>0){var i=a[0];return this._internalGetElement(i)}return null},_internalGetValue:function(t){var n=null;if(t){var i=t.name,a=e.PM.xRTML.Sizzle("input[name="+i+"]:checked",this.context)[0];if(a)if("value"===this.expressionData.attribute)n=a.value;else if("innerText"===this.expressionData.attribute){var s=e.PM.xRTML.Sizzle("[for="+a.id+"]",this.context)[0];n=e.PM.Utils.helpFunctions.getTextFromElement(s)}n&&this.fire({readUpdate:{value:n,expressionData:this.expressionData}}),this.expressionData.parser&&this.expressionData.parser.length>0&&(n=this.parserAnalyser(n)),n=this._convertType(n)}return n},_checkType:function(){throw"abstract class, must override method checkType"},_convertType:function(){throw"abstract class, must override method convertToValue"}}),t.PollTextExpression=t.PollExpression.extend({init:function(e,t,n){this._super(e,t,n)},_checkType:function(e){if(e==n||"string"!=typeof e)throw"Invalid text field in "+expressionData.expression+" expression or some condition"},_convertType:function(e){return this._checkType(e),e}}),t.PollNumericExpression=t.PollExpression.extend({init:function(e,t,n){this._super(e,t,n)},_checkType:function(e){if(isNaN(parseFloat(e)))throw"Invalid numeric field in "+expressionData.expression+" expression or some condition"},_convertType:function(e){var t=parseFloat(e);try{this._checkType(e)}catch(n){return null}return t}})}(t.Selectors=t.Selectors||{})}(e.PM=e.PM||{}),function(t){!function(n,a){n.BaseSelector=PMClass.extend({init:function(t,n,s){if(e.PM.xRTML.Event.extend(this),t.expressions.length<1)throw"No expressions defined.";this.selectorData=t,this.id=i.Common.Util.idGenerator(),this.prevValue=a,this.outputHandler=n,this.throtleHandler=s,this.recursive=t.runIframes||!1,2===this.selectorData.executionType&&this.clearElapsedTime()},isOneTime:function(){return 1===this.selectorData.executionType},timeInterval:function(){return this.selectorData.timeInterval},getElapsedTime:function(){return this.elapsedTime},clearElapsedTime:function(){this.elapsedTime=0},addElapsedTime:function(e){this.elapsedTime+=e},execute:function(){var t=this,n=null;try{n=this._getValue()}catch(i){e.PM.xRTML.Console.debug("Error running selector "+this.selectorData.name+". error: "+i),this.fire({invalidSelectorValue:{}})}var s=this._compareValues(this.prevValue,n);s&&null!=n&&n!=a&&("function"==typeof this.throtleHandler&&this.throtleHandler(this.id,n,e.PM.xRTML.Common.Function.proxy(this._sendMessage,t)),this._fireChangedValueEvent({value:n})),this.prevValue=n},_sendMessage:function(t){var n=t.value,i={a:null,d:{}};i=this._buildMessage(i,n),this.outputHandler?this.outputHandler(i):e.PM.EventManager.send(i.a,i.d)},_createExpressions:function(e,t){var n=e.createInstance(t),i=this;return n.bind({readUpdate:function(e){i.fire({readUpdate:{value:e.value,expressionData:e.expressionData}})},cleanupUpdate:function(e){i.fire({cleanupUpdate:{value:e.value,expressionData:e.expressionData}})},conditionUpdate:function(e){i.fire({conditionUpdate:{value:e.value,expressionData:e.expressionData}})},eventValueUpdate:function(e){i.fire({eventValueUpdate:{value:e.value,expressionData:e.expressionData}})}}),n},_getValue:function(){throw"abstract function"},_compareValues:function(){throw"abstract function"},_buildMessage:function(){throw"abstract function"},_fireChangedValueEvent:function(){throw"abstract function"}}),n.AreaSelector=n.BaseSelector.extend({init:function(e,t,i){if(e.expressions.length>1)throw"Invalid expression set for area selector.";this._super(e,t,i);var a=n.Utils.getFactory(n.ExpressionFactory);this.expression=this._createExpressions(a,e.expressions[0])},_getValue:function(){return 1==this.expression.getValue(this.recursive)},_compareValues:function(e,t){return e===t?!1:t?!0:!t&&e?!0:!1},_buildMessage:function(e,t){return e.a="SectionChanged",e.d.areaId=this.selectorData.areaId,e.d.isEnabled=t,e},_fireChangedValueEvent:function(t){var n=t;n.id=this.selectorData.areaId,e.PM.Events.fire({AreaSelectorChanged:n})}}),n.CustomFieldSelector=n.BaseSelector.extend({init:function(e,t,i){if(this._super(e,t,i),this.isFirstExecute=!0,this.isValueCustomField=2!==this.selectorData.customFieldType,this.isValueCustomField&&e.expressions.length>1)throw"Invalid expression set for custom field selector of Value Custom Field.";this.expressionsList=[];for(var a=n.Utils.getFactory(n.ExpressionFactory),s=0;s<e.expressions.length;s++)this.expressionsList.push(this._createExpressions(a,e.expressions[s]))},_getValue:function(){var e;if(this.isValueCustomField)e=this.expressionsList[0].getValue(this.recursive);else{var t;e={};for(var n=0;n<this.expressionsList.length;n++)t=this.expressionsList[n],e[t.getData().target]=t.getValue(this.recursive)}return e},_compareValues:function(t,n){var i;if(this.isValueCustomField)i=t!==n;else if(t&&n){i=!1;for(var a in t)if(t[a]!==n[a]){i=!0;break}}else i=!0;return e.PM.SessionData.customFieldsHistory&&this.isFirstExecute&&this.selectorData.persistInCookie&&i&&(this.prevValue=n,i=!1),this.isFirstExecute=!1,i&&this.selectorData.persistInCookie&&this._persistInCookie(n),i},_buildMessage:function(e,t){return e.a=this.isValueCustomField?"ValueCustomFieldChanged":"ObjectCustomFieldChanged",e.d.customFieldId=this.selectorData.customFieldId,e.d.value=t,this.selectorData.persist!=a&&(e.d.persist=this.selectorData.persist),e},_persistInCookie:function(e){n.Utils.cookies.savecustomFieldToCookie({id:this.selectorData.customFieldId,value:e})},_fireChangedValueEvent:function(n){var i=new t.Event("CustomFieldChanged","CustomField","Changed",this.selectorData.customFieldId,n.value);e.PM.Events.fire({CustomFieldChanged:i})}}),n.ListSelector=n.BaseSelector.extend({init:function(t,i,a){this._super(t,i,a);for(var s=this.expressionsList=[],o=n.Utils.getFactory(n.ExpressionFactory),r=0;r<t.expressions.length;r++)s.push(o.createInstance(t.expressions[r]));if(t.getMessage){var c=e.PM.Utils.string.trim(t.getMessage),l=c.substring(c.indexOf("(")+1,c.indexOf(")"));c=c.substring(c.indexOf("{")+1,c.length-1),t.getMessage=new Function(l,c),"function"!=typeof t.getMessage&&(this.getMessage=function(){})}else this.getMessage=function(){}},_getValue:function(){for(var e,t=[],n=0;n<this.expressionsList.length;n++)e=this.expressionsList[n],t[e.expressionData.target]=e.getValue(this.recursive,!0);return t},_compareValues:function(e,t){var n,i;if(!e)return!0;for(var a in e){if(n=e[a],i=t[a],n.length!==i.length)return!0;for(var s=0;s<n.length;++s)if(n[s]!==i[s])return!0}return!1},_buildMessage:function(e,t){var n,i=[],a=[];for(var s in t)a.push(s);for(var o=a[0],r=0;r<t[o].length;r++){n={};for(var c=0;c<a.length;c++)n[a[c]]=t[a[c]][r];i.push(n)}return this.selectorData.getMessage(i)},_fireChangedValueEvent:function(){}}),n.PollSelector=n.BaseSelector.extend({init:function(e,t,i){this._super(e,t,i),this.expression=n.Utils.getFactory(n.ExpressionFactory).createInstance(e.expressions[0])},_getValue:function(){return this.expression.getValue(this.recursive)},_compareValues:function(e,t){return e===t?!1:t?!0:!t&&e?!0:!1},_buildMessage:function(e,t){return e.a="ValueCustomFieldChanged",e.d.customFieldId=this.selectorData.customFieldId,e.d.value=t,e},_fireChangedValueEvent:function(t){var n=t;n.id=this.selectorData.customFieldId,e.PM.Events.fire({PollCustomFieldChanged:n})}}),n.VisitorFieldSelector=n.BaseSelector.extend({init:function(e,t,i){if(this._super(e,t,i),this.isFirstExecute=!0,this.fieldName=this.selectorData.visitorFieldName,"string"!=typeof this.fieldName||""==this.fieldName)throw"Invalid Visitor Field Name.";var a=n.Utils.getFactory(n.ExpressionFactory);this.expression=this._createExpressions(a,e.expressions[0])},_getValue:function(){return this.expression.getValue(this.recursive)},_compareValues:function(e,t){return e!==t},_buildMessage:function(e,t){return e.a="VisitorFieldChanged",e.d.fieldName=this.fieldName,e.d.value=t,e},_fireChangedValueEvent:function(n){var i=new t.Event("VisitorFieldChanged","VisitorField","Changed",this.fieldName,n.value);e.PM.Events.fire({VisitorFieldChanged:i})}}),n.SelectorFactory=function(){var t={1:function(e,t,i){return new n.AreaSelector(e,t,i)},2:function(e,t,i){return new n.CustomFieldSelector(e,t,i)},3:function(e,t,i){return new n.PollSelector(e,t,i)},4:function(e,t,i){return new n.VisitorFieldSelector(e,t,i)},999:function(e,t,i){return new n.ListSelector(e,t,i)}};this.createInstance=function(n,i,a){var s=t[n.type];if(!s)return e.PM.xRTML.Console.log("Ignored invalid selector type:"+n.type),null;var o;try{o=s(n,i,a)}catch(r){e.PM.xRTML.Console.log("Error building selector:"+r)}return o}},n.Engine=function(i){this.selectorInstances=[],e.PM.xRTML.Event.extend(this);var s=new e.PM.Utils.throtle(500,1e3,3e3),o=[],r=!1,c=this,l=function(e){0==e.isOneTime()&&o.push(e),u(e),c.selectorInstances.push(e)},d=function(){if(h(),o.length>0){var e=500;this.timerHandler=setInterval(function(){for(var t,n=o.length-1;n>=0;n--)t=o[n],t.addElapsedTime(e),t.getElapsedTime()>=t.timeInterval()&&(u(t),t.clearElapsedTime())},e)}},u=function(e){e.execute()},h=function(){if(e.PM.SessionData.customFieldsHistory){var t=e.PM.SessionData.customFieldsHistory;for(var n in t){var i=t[n],a=n,s={a:"ValueCustomFieldChanged",d:{customFieldId:a,value:i,persist:!0}};e.PM.EventManager.send(s.a,s.d)}}},p=n.Utils.getFactory(n.SelectorFactory),f=this,v=function(e){f.fire({readUpdate:{value:"Error. Invalid selector configuration.",expressionData:e.expressionData}})},g=function(e){f.fire({readUpdate:{value:e.value,expressionData:e.expressionData}})},m=function(e){f.fire({cleanupUpdate:{value:e.value,expressionData:e.expressionData}})},M=function(e){f.fire({conditionUpdate:{value:e.value,expressionData:e.expressionData}})},b=function(t){var n=t.value;this._compareValues(this.prevValue,n)&&null!=n&&n!=a&&("function"==typeof this.throtleHandler&&this.throtleHandler(this.id,n,e.PM.xRTML.Common.Function.proxy(this._sendMessage,this)),this._fireChangedValueEvent({value:n})),this.prevValue=n};this.start=function(e){this.reset(),t.Events.fire({SelectorsFirstIterationCompleted:new t.Event("SelectorsFirstIterationStarted")});for(var n=0;n<e.length;++n){var a=p.createInstance(e[n],i,s.setThrotle);a&&(a.bind({invalidSelectorValue:v,readUpdate:g,cleanupUpdate:m,conditionUpdate:M,eventValueUpdate:b}),l(a))}d(),r=!0,t.Events.fire({SelectorsFirstIterationCompleted:new t.Event("SelectorsFirstIterationCompleted")})},this.isFirstIterationCompleted=function(){return r},this.reset=function(){this.stop(),o=[],r=!1},this.stop=function(){this.timerHandler&&clearInterval(this.timerHandler)}}}(t.Selectors=t.Selectors||{})}(e.PM=e.PM||{}),e.PM.Events.once({pmReady:function(){if(e.PM.SessionData.selectors){e.PM.SessionData.selectors.engines=e.PM.SessionData.selectors.engines||[];var t=new n.Selectors.Engine;t.start(e.PM.SessionData.selectors),e.PM.SessionData.selectors.engines.push(t)}},onVisitorDispose:function(){for(var t=0;t<e.PM.SessionData.selectors.engines.length;t++){var n=e.PM.SessionData.selectors.engines[t];n.reset()}e.PM.SessionData.selectors.engines=[]}}),function(i){var a=new function(){var n=this,a=i.AdStatusManager=new function(){var t={discarded:{value:0},received:{value:1},toastInit:{value:1,next:function(e){return e?t.toastClicked:t.toastIgnored},interrupt:function(){return t.toastInterrupted}},toastIgnored:{value:2},toastInterrupted:{value:3},toastClicked:{value:4,next:function(e){return e?t.toastClickedBannerClicked:t.toastClickedBannerIgnored},interrupt:function(){return t.toastClickedBannerInterrupted}},toastClickedBannerIgnored:{value:5},toastClickedBannerInterrupted:{value:6},toastClickedBannerClicked:{value:7},bannerInit:{value:1,next:function(e){return e?t.bannerClicked:t.bannerIgnored},interrupt:function(){return t.bannerInterrupted}},bannerIgnored:{value:8},bannerInterrupted:{value:9},bannerClicked:{value:10}},n=function(t,n,i){e.PM.EventManager.send("adStatus",{pid:i,status:n.value})},i=function(){},a={};this.checkSetAd=function(n,o){var r=n.metaData.pushId,c=a[r];if(c){if(c.status!=t.toastClicked)throw e.PM.xRTML.Console.log("Unexpected ad state"),"Unexpected ad state"}else n.metaData&&n.metaData.id&&(a[r]={id:n.metaData.id,status:o?t.toastInit:t.bannerInit,pushId:r},s(r),n.metaData.sendFeedback&&i(n.metaData.id))};var s=function(e){var t=a[e];n(t.id,t.status,t.pushId),t.status.next||delete a[e]};this.setNextAdStatus=function(e,t){var n=e.metaData.pushId,i=a[n];i&&(i.status=i.status.next(t),s(n))},this.setAdClosed=function(e){var t=e.metaData.pushId,n=a[t];n&&(n.status=n.status.interrupt(),s(t))},this.setAdDiscarded=function(e){var n=e.metaData.pushId;a[n]={id:e.metaData.id,status:e.displayToast?t.toastIgnored:t.bannerIgnored,pushId:n},s(n)},this.setContentStatus=function(e,n){var i=e.pushId;a[i]={id:e.id,status:n?t.received:t.discarded,pushId:i},s(i)}},s=function(t,n,i,a){var s=t+n,o={};o[s]=new e.PM.Event(s,"Push Campaign",s,i,a),e.PM.Events.fire(o)},o=function(e){var t=e.bannerType&&e.bannerType!=e.destinationTarget?e.bannerType:"";return"iframe"==t&&(t="html"),t},r=function(e){var t,n,i="";return e.metaData&&(e.metaData.id&&(i=e.metaData.id),e.metaData.label&&(t=e.metaData.label)),n=t?i+" - "+t:i},c=function(e){e.display_time=new Date},l=function(e){var t;return e.display_time&&(t=(new Date-e.display_time)/1e3),t},d=function(e,t){var n=0;if("_self"===e.destinationTarget){a.setNextAdStatus(e,!0),action="Clicked";var i=l(e);if(i){var c=e.displayBanner?"":"toast";s(c+o(e),action,r(e),i),n=50}}setTimeout(function(){t()},n)},u=function(e){return e.bannerType==e.destinationTarget};this.audioTag=null;var h,p,f=function(n,i){p&&(h?clearInterval(p):clearTimeout(p),t.title=originalTittle),e.focused||(originalTittle=t.title,t.title=i?n+" - "+i:n,h=!1,p=setTimeout(function(){h=!0,p=setInterval(function(){t.title.length>0?t.title=t.title.substr(1):(clearInterval(p),h=!1,p=setTimeout(function(){t.title=originalTittle,p=null},250))},100)},1e3))},v=function(){var i={id:"Audio002",name:"Audio",channelid:e.PM.SessionData.account.channels.public_fromServer,controlsbar:!1,resources:[{name:"swfobject",resource:e.PM.SessionData.resources.swfobject}]};e.PM.xRTML.TagManager.create(i,function(e){n.audioTag=e,e.bind({play:function(e){s("audio","Received",r(e.source)),f(t.title),a.checkSetAd(e.source,!1)}})})},g=function(){n.audioTag.dispose()};this.toastTag=null;var m="xRTML-Toast-template",M="xRTML-Toast-target",b=function(){if(0==e.PM.xRTML.Sizzle("#"+m).length){var n='<div id="rt-powermarketing_toast" class="rt-powermarketing_toast">';n+='    <div class="rt-pm_toast_content">',n+='        <div class="rt-pm_toast_header"><h3 data-bind="text: title"></h3></div>',n+='        <div class="rt-pm_toast_body">',n+="            <!-- ko ifnot: displayBanner || destinationUrl -->",n+='            <p data-bind="text: text"></p>',n+='            <div class="rt-pm_toast_buttons">',n+='                <a class="rt-pm_toast_button_close" data-bind="click: close">Close</a>',n+="            </div>",n+="            <!-- /ko -->",n+="            <!-- ko if: displayBanner || destinationUrl -->",n+='                <p data-bind="text: text, click: showBanner" class="xrtml-toast-content-clickable"></p>',n+='                <div class="rt-pm_toast_buttons">',n+='                    <!-- ko if: destinationUrl=="http://www.powermarketing.com/requestChat" -->',n+='                        <a class="rt-pm_toast_button_ok" data-bind="click: function(){setTimeout(function() { window.PM.Interactions.Manager._uiManager.forceOpenMenu();}, 10); $data.close(\'requestChat\');}">OK</a>',n+="                    <!-- /ko -->",n+='                    <!-- ko ifnot: destinationUrl=="http://www.powermarketing.com/requestChat" -->',n+='                        <!-- ko if: !displayBanner && destinationUrl && destinationTarget == "_blank" -->',n+="                            <!-- ko if: download -->",n+='                                <a class="rt-pm_toast_button_ok" data-bind="click: showBanner, attr: { href: destinationUrl, target: destinationTarget }"download>OK</a>',n+="                            <!-- /ko -->",n+="                            <!-- ko if: !download -->",n+='                                <a class="rt-pm_toast_button_ok" data-bind="click: showBanner, attr: { href: destinationUrl, target: destinationTarget }">OK</a>',n+="                            <!-- /ko -->",n+="                        <!-- /ko -->",n+='                        <!-- ko if: displayBanner || !destinationUrl || destinationTarget != "_blank" -->',n+='                            <a class="rt-pm_toast_button_ok" data-bind="click: showBanner">OK</a>',n+="                        <!-- /ko -->",n+="                    <!-- /ko -->",n+='                    <a class="rt-pm_toast_button_close" data-bind="click: close">Close</a>',n+="                </div>",n+="            <!-- /ko -->",n+="        </div>",n+="    </div>",n+="</div>",i.xRTML.Templating.inject({id:"xRTML-Toast-template",content:n})}if(0==e.PM.xRTML.Sizzle("#"+M).length){var a=t.createElement("div");a.id=M,a.className=M,t.body.appendChild(a)}},x=function(){b();var t={id:"toast001",name:"Toast",template:m,positionat:"bottomright",controlsBar:!0,target:"#"+M,resources:[{name:"swfobject",resource:e.PM.SessionData.resources.swfobject}],bannerTransition:function(e,t){d(e,t)}};e.jQuery&&(t.jqueryeffects=[{id:"tagToastEffect1",name:"animate",properties:'{ "opacity": "0", "height": "0"  }',options:'{"duration":0}'},{id:"tagToastEffect1",name:"animate",properties:'{ "height": "110px" }',options:'{"duration":350}'},{id:"tagToastEffect2",name:"animate",properties:'{ "opacity": "1" }',options:'{"duration":1000}'}]),e.PM.xRTML.TagManager.create(t,function(e){n.toastTag=e,e.bind({toastDisplay:function(e){a.checkSetAd(e.target,!0),c(e.target),s("toast"+o(e.target),"Received",r(e.target))},toastClose:function(e){var t;"CloseButton"==e.info?(a.setAdClosed(e.target),t="Closed"):(a.setNextAdStatus(e.target,"ShowBanner"==e.info||"OpenUrl"==e.info||"requestChat"==e.info),t="TimeOut"==e.info?"Ignored":"Clicked");var n=l(e.target);
n&&s("toast"+o(e.target),t,r(e.target),n)},bannerDisplay:function(e){a.checkSetAd(e.target,!1),c(e.target),u(e.target)||s(o(e.target),"Received",r(e.target))},bannerClose:function(e){var t;u(e.target)||("CloseBanner"!=e.info&&e.info&&"CloseURL"!=e.info?(a.setNextAdStatus(e.target,"OpenUrl"==e.info),t="TimeOut"==e.info?"Ignored":"Clicked"):(a.setAdClosed(e.target),t="Closed"),s(o(e.target),t,r(e.target),l(e.target)))},toastDiscarded:function(e){a.setAdDiscarded(e.target)}})})},T=function(){n.toastTag.dispose()};this.init=function(){v(),x()},this.dispose=function(){T(),g()}};e.PM.SessionData.isEldestPM&&!n.Utils.dom.isCrossOrigin()&&e.PM.Events.once({pmReady:function(){e.PM.SessionData.account.modules.push("Tags"),a.init()},onVisitorDispose:function(){a.dispose();var t=e.PM.SessionData.account.modules.indexOf("Tags");-1!=t&&e.PM.SessionData.account.modules.splice(t,1)}})}(e.PM=e.PM||{}),function(i){var a=new function(){var n=this,a=new function(){var n={image:0,html:1,iframe:2,selfhostedvideo:3,youtubevideo:4},i=function(n){var i=t.createElement("a");return i.href=n,i.search.length>0&&(i.search+="&"),i.search+="rtid="+e._realtimeSessionId,i.href},a=function(e,t){var n=e.toast;if(t.displayToast=n?!0:!1,t.displayToast){if(t.title=n.title.value,t.text=n.text.value,t.timeToLive=1e3*n.timeToLive.value,t.download=n.download?!!n.download.value:!1,n.linkUrl&&n.linkUrl.value&&(t.destinationUrl="http://www.powermarketing.com/requestChat"===n.linkUrl.value?n.linkUrl.value:i(n.linkUrl.value)),n.showInIframe&&n.showInIframe.value){var a=n.iframeWidth,s=n.iframeHeight;s&&s.value>0&&a&&a.value>0&&(t.destinationTarget="iframe",t.destinationTargetWidth=a.value,t.destinationTargetHeight=s.value)}n.showInCurrentTab&&n.showInCurrentTab.value&&(t.destinationTarget="_self")}},s=new function(){var e=function(e,t){t.bannerWidth=e.width.value,t.bannerHeight=e.height.value},t=function(e,t){t.bannerWidth=565,t.bannerHeight=320};this[n.image]=function(e,t){if(t.bannerType="image",t.bannerUrl=i(e.imageUrl.value),e.linkUrl&&e.linkUrl.value&&(t.destinationUrl=i(e.linkUrl.value)),e.timeToLive&&e.timeToLive.value>0&&(t.bannerAutoHide=1e3*e.timeToLive.value),e.showInIframe&&e.showInIframe.value){var n=e.iframeWidth,a=e.iframeHeight;a&&a.value>0&&n&&n.value>0&&(t.destinationTarget="iframe",t.destinationTargetWidth=n.value,t.destinationTargetHeight=a.value)}e.showInCurrentTab&&e.showInCurrentTab.value&&(t.destinationTarget="_self")},this[n.html]=function(t,n){n.bannerType="html",n.bannerContent=t.body&&t.body.value?t.body.value:"",e(t,n),t.timeToLive&&t.timeToLive.value>0&&(n.bannerAutoHide=1e3*t.timeToLive.value)},this[n.iframe]=function(t,n){n.bannerType="iframe",n.bannerUrl=i(t.url.value),e(t,n),t.timeToLive&&t.timeToLive.value>0&&(n.bannerAutoHide=1e3*t.timeToLive.value)},this[n.youtubevideo]=function(e,n){n.bannerType="video",n.bannerSource={files:{yt:e.videoUrl.value},autoplay:!0,playNow:!0},t(e,n)},this[n.selfhostedvideo]=function(e,n){n.bannerType="video";for(var i={},a=0;a<e.files.length;++a)e.files[a].filetype&&e.files[a].url&&(i[e.files[a].filetype]=e.files[a].url);n.bannerSource={files:i,autoplay:!0,playNow:!0},t(e,n)}},o=function(e,t){var n=e.banner;if(n){var i=s[n.type];i&&(t.displayBanner=!0,i(n.content,t))}else t.displayBanner=!1};this.createAdMessage=function(t){var n={},i=e.PM.xRTML.JSON.parse(t.adConfig);return t.id&&(n.metaData={id:t.id,label:i.label,pushId:t.pushId}),t.setVisitorPushData&&(n.metaData.sendFeedback=t.setVisitorPushData),a(i,n),o(i,n),n},this.createAudioMessage=function(t){for(var n={},i=e.PM.xRTML.JSON.parse(t.adConfig),a=i.audio.files,s=0;s<a.length;++s)a[s].filetype&&a[s].url&&(n[a[s].filetype]=a[s].url);var o;return t.id&&(o={id:t.id,label:i.label,pushId:t.pushId}),{files:n,autoplay:!0,loop:!1,playNow:!0,metaData:o}}},s=function(){e.PM.xRTML.TagManager.create({name:"Execute",triggers:["Process_Toast"],callback:function(t){try{var n=a.createAdMessage(t);t.discardable&&(n.entryTimeout=3e4),e.PM.xRTML.TagManager.getById("toast001").process(n)}catch(i){var s="N/A";try{s=t.label}catch(i){}e.PM.xRTML.Console.debug("Could not play the ad: "+s)}}},function(e){n.toastProcessorTag=e})},o=function(){var t={html:0,iframe:1};e.PM.xRTML.TagManager.create({name:"Execute",triggers:["Process_Content"],callback:function(n){try{for(var a=[],s=n.selectors.length-1;s>=0;s--)a=a.concat(i.Selectors.Utils.getElements(n.selectors[s].selector,n.selectors[s].runIframes));if(0===a.length)return void i.AdStatusManager.setContentStatus(n,!1);for(var o=e.PM.xRTML.JSON.parse(n.config),r=null,c=null,l=a.length-1;l>=0;l--){for(r=a[l];c=r.lastChild;)r.removeChild(c);switch(n.type){case t.html:r.innerHTML=o.content;break;case t.iframe:r.innerHTML='<iframe src="'+o.src+'" style="width: '+o.width+", height: "+o.height+'"></iframe>'}}i.AdStatusManager.setContentStatus(n,!0)}catch(d){var u="N/A";try{u=n.label,i.AdStatusManager.setContentStatus(n,!1)}catch(d){}e.PM.xRTML.Console.debug("Could not switch the content: "+u)}}},function(e){n.contentProcessorTag=e})},r=function(){e.PM.xRTML.TagManager.create({name:"Execute",triggers:["Process_Audio"],callback:function(t){try{var n=e.PM.xRTML.TagManager.getById("Audio002");n.isPlaying()&&n.stop(),n.play(a.createAudioMessage(t))}catch(i){var s="N/A";try{s=t.label}catch(i){}e.PM.xRTML.Console.debug("Could not play the sound: "+s)}}},function(e){n.audioProcessorTag=e})};this.toastProcessorTag=null,this.audioProcessorTag=null,this.contentProcessorTag=null,this.init=function(){s(),r(),o()},this.dispose=function(){n.toastProcessorTag.dispose(),n.audioProcessorTag.dispose(),n.contentProcessorTag.dispose()}};e.PM.SessionData.isEldestPM&&!n.Utils.dom.isCrossOrigin()&&e.PM.Events.once({pmReady:function(){e.PM.SessionData.account.modules.push("TagManager"),a.init()},onVisitorDispose:function(){a.dispose();var t=e.PM.SessionData.account.modules.indexOf("TagManager");-1!=t&&e.PM.SessionData.account.modules.splice(t,1)}})}(e.PM=e.PM||{}),function(t){!function(t,i){var a="www.directv.com/DTVAPP/new_customer/shopping_cart.jsp#!&_h=",s="pmDirecttvCookie",o=i,r=this;t.initialize=function(){var t=c();l()?d()?d()&&e.PM.Storage.remove(s):(t.passed=!0,e.PM.Storage.update(s,t),o=setInterval(e.PM.xRTML.Common.Function.proxy(function(){d()&&(e.PM.Storage.remove(s),clearInterval(o))},r),1e3)):t.passed===!0&&(this.action(),t.passed=!1,e.PM.Storage.update(s,t))};var c=function(){var t=e.PM.Storage.get(s);if(t)return t.value;var n={passed:!1};return e.PM.Storage.add(s,n),n},l=function(){return-1!==e.location.href.indexOf(a)},d=function(){var t=e.PM.xRTML.Sizzle(".cart-totals-tup .cart-totals-once table tr:nth-child(2) td:nth-child(2)");return t&&t[0]!==i};t.action=function(){n.ConnectionManager.connection.send({channel:e.PM.SessionData.account.channel.private_fromClient,content:e.PM.SessionData.swid+"_"+e.PM.xRTML.JSON.stringify({a:"ValueCustomFieldChanged",wsid:e.PM.SessionData.wsid,d:{customFieldId:"470",value:"magicvalue33",persist:!0},sid:n.SessionData.realtimeSessionId,cid:n.SessionData.realtimeContextId})})},e.PM.Events.once({pmReady:function(){"DyGqhh"===e._appKey&&e.PM.DirectTv.initialize()}})}(t.DirectTv=t.DirectTv||{})}(e.PM=e.PM||{})}(PMWindow,PMWindow.document,PMWindow.PM=PMWindow.PM||{},PMWindow.xRTML=PMWindow.xRTMLVersions["3.2.7"]||{});